"use strict";var Ee=Object.create;var M=Object.defineProperty;var Be=Object.getOwnPropertyDescriptor;var xe=Object.getOwnPropertyNames;var Oe=Object.getPrototypeOf,Ie=Object.prototype.hasOwnProperty;var Ae=(t,r)=>()=>(r||t((r={exports:{}}).exports,r),r.exports),ze=(t,r)=>{for(var e in r)M(t,e,{get:r[e],enumerable:!0})},V=(t,r,e,o)=>{if(r&&typeof r=="object"||typeof r=="function")for(let n of xe(r))!Ie.call(t,n)&&n!==e&&M(t,n,{get:()=>r[n],enumerable:!(o=Be(r,n))||o.enumerable});return t},B=(t,r,e)=>(V(t,r,"default"),e&&V(e,r,"default")),x=(t,r,e)=>(e=t!=null?Ee(Oe(t)):{},V(r||!t||!t.__esModule?M(e,"default",{value:t,enumerable:!0}):e,t)),_e=t=>V(M({},"__esModule",{value:!0}),t);var se=Ae(O=>{"use strict";O.__esModule=!0;O.OpenAPIV2=O.OpenAPIV3=void 0;var we;(function(t){var r;(function(e){e.GET="get",e.PUT="put",e.POST="post",e.DELETE="delete",e.OPTIONS="options",e.HEAD="head",e.PATCH="patch",e.TRACE="trace"})(r=t.HttpMethods||(t.HttpMethods={}))})(we=O.OpenAPIV3||(O.OpenAPIV3={}));var Ce;(function(t){var r;(function(e){e.GET="get",e.PUT="put",e.POST="post",e.DELETE="delete",e.OPTIONS="options",e.HEAD="head",e.PATCH="patch"})(r=t.HttpMethods||(t.HttpMethods={}))})(Ce=O.OpenAPIV2||(O.OpenAPIV2={}))});var T={};ze(T,{ApiError:()=>H,AppliedSecurity:()=>$,FormDataBody:()=>D,HtmlBody:()=>te,HttpResponse:()=>C,JsonBody:()=>R,METHODS:()=>Y,OctetStreamBody:()=>z,Security:()=>ee,TextBody:()=>G,UrlEncodedBody:()=>q,applyGroupConfig:()=>$e,buildJson:()=>Le,createApi:()=>Ne,endpoint:()=>He,mergeEndpointGroups:()=>ke,oas3:()=>Se.OpenAPIV3_1});module.exports=_e(T);B(T,require("@routejs/router"),module.exports);var Se=x(se());var k=x(require("fs")),me=x(require("path")),le=require("stream"),ye=x(require("url")),fe=x(require("cors")),ge=require("radash"),he=require("zod");var W=require("fast-content-type-parse"),X=require("radash");var ne=require("crypto");function oe(t,r){let e="",o=0,n=[],a=[],s=[],p={};for(let m=0;m<t.length;m++){let c=t[m]??NaN,f=m>0?t[m-1]??null:null,d=c===10&&f===13;if(c===10||c===13||(e+=String.fromCharCode(c)),o===0&&d)`--${r}`===e&&(o=1),e="";else if(o===1&&d)e.length?s.push(e):(p=Object.fromEntries(s.flatMap(y=>{let[i,P=""]=y.split(":");return i?.trim()?[[i.trim().toLowerCase(),P?.trim()]]:[]})),o=2,n=[]),e="";else if(o===2){if(e.length>r.length+4&&(e=""),`--${r}`===e){let y=n.length-e.length,i=n.slice(0,y-1);a.push(De({headers:p,part:i})),n=[],s=[],p={},e="",o=3}else n.push(c);d&&(e="")}else o===3&&d&&(o=1)}return a}function De(t){let r=je(t.headers["content-disposition"]??"");return{headers:t.headers,name:r.name,data:Buffer.from(t.part),...r.filename&&{filename:r.filename,type:t.headers["content-type"]?.trim()}}}function je(t){let r={type:null,name:null,filename:null},e=t.split(";").map(o=>o.trim());e[0]&&(r.type=e[0].toLowerCase());for(let o of e.slice(1)){let[n,a]=o.split("=").map(s=>s.trim());n&&a&&(r[n.toLowerCase()]=a.replace(/^"|"$/g,""))}return r}function Q(t="----------------------"){return`--${t}${(0,ne.randomBytes)(12).toString("hex")}`}async function ae(t,r=Q()){let e=[];for(let[o,n]of Object.entries(t))for(let a of n)e.push(Buffer.from(`--${r}`)),typeof a=="string"?e.push(Buffer.from(`Content-Disposition: form-data; name="${o}"\r
\r
`),Buffer.from(a),Buffer.from(`\r
`)):a instanceof File&&e.push(Buffer.from(`Content-Disposition: form-data; name="${o}"; filename="${a.name}"\r
`),Buffer.from(`Content-Type: ${a.type||"application/octet-stream"}\r
\r
`),Buffer.from(await a.arrayBuffer()),Buffer.from(`\r
`));return e.push(Buffer.from(`--${r}--\r
`)),Buffer.concat(e)}var I=class extends Error{statusCode;constructor(r,e){super(e),this.statusCode=r}};function ie(t){return new Promise((r,e)=>{let o=[];t.on("data",n=>o.push(n)),t.on("end",()=>r(Buffer.concat(o))),t.on("error",n=>e(n))})}function pe(t,r,e){if(!t.length)return;let o;try{o=(0,W.parse)(r??"")}catch(n){throw new I(400,String(n))}if(o.type==="application/json")try{let n=o.parameters.charset??"utf-8";return JSON.parse(t.toString(n))}catch(n){throw new I(400,String(n))}else if(o.type==="multipart/form-data"){let n=o.parameters.boundary?.trim().replace(/^["']|["']$/g,"");if(!n)throw new I(400,"Cannot find multipart boundary");let a=oe(t,n),s={};for(let p of a){let m=p.headers["content-type"],f=(m?(0,W.parse)(m):null)?.parameters.charset??"utf-8";if(!p.name)continue;let d=p.filename?new File([p.data],p.filename,p.type?{type:p.type}:{}):p.data.toString(f);(s[p.name]??=[]).push(d)}return e?.multiValueFormData?s:(0,X.mapValues)(s,p=>p.at(-1))}else if(o.type==="application/x-www-form-urlencoded"){let n=o?.parameters.charset??"utf-8",a=t.toString(n),s=new URLSearchParams(a),p={};for(let[m,c]of s.entries())(p[m]??=[]).push(c);return e?.multiValueUrlEncoded?p:(0,X.mapValues)(p,m=>m.at(-1))}else{if(o.type==="application/octet-stream")return t;{let n=`'${o.type}' content type is not supported`;throw new I(415,n)}}}function de(t){return t.split(";").reduce((r,e)=>{let[o,...n]=e.trim().split("=");return o&&(r[o]=decodeURIComponent(n.join("="))),r},{})}var N=class extends Error{errors=[];constructor(){super()}addIssue(r){this.errors.push(r)}hasIssue(){return this.errors.length>0}};function ce(t,r){let e=new N,o=r.requestBody?.body.safeParse(t.body);o?.error&&e.addIssue({in:"body",result:o.error.errors});let n=r.parameters?.query?.safeParse(t.queries);n?.error&&e.addIssue({in:"queries",result:n.error.errors});let a=r.parameters?.path?.safeParse(t.params);a?.error&&e.addIssue({in:"params",result:a.error.errors});let s=r.parameters?.header?.safeParse(t.headers);s?.error&&e.addIssue({in:"headers",result:s.error.errors});let p=r.parameters?.cookie?.safeParse(t.cookies);if(p?.error&&e.addIssue({in:"cookies",result:p.error.errors}),e.hasIssue())throw e;return{body:o?.data,queries:n?.data??{},params:a?.data??{},headers:s?.data??{},cookies:p?.data??{}}}function ue(t){let r=/:([^/]+)/g,e=L(t).replace(r,"{$1}"),o=[],n=null;for(;(n=r.exec(t))!==null;)o.push(n[1]);return{path:e,params:o}}function L(t){return t.replace(/\/+/gi,"/")}function Ne(t,r,e){e?.cors&&t.use((0,fe.default)(typeof e.cors=="boolean"?{}:e.cors)),e?.logger?.info?.(`Registering ${Object.keys(r).length} endpoints...`);let o=new Set;for(let[n,a]of Object.entries(r)){let[s="",...p]=n.split(":"),m=p.join(":");if(o.has(a.operationId))throw new Error(`Duplicate operation ID "${a.operationId}" for path ${m}`);if(o.add(a.operationId),!Y.some(c=>c===s))throw new Error(`Invalid method "${s}" for path ${m}`);e?.logger?.info?.(`${a.operationId} -> ${s.toUpperCase()} ${m}`),t[s](m,async(c,f)=>{try{let d=await ie(c),g=pe(d,c.headers["content-type"]??""),y={};if(a.security?.length)for(let b of a.security)await b.authenticate(c,y);let i=c.url?new URLSearchParams(c.url.split("?")[1]):[],P={};for(let[b,_]of i.entries())(P[b]??=[]).push(_);let K=ce({body:g,queries:e?.request?.multiValueQueryString?P:(0,ge.mapValues)(P,b=>b.at(-1)),cookies:de(c.headers.cookie??""),params:c.params,headers:c.headers},a),v=await a.handler(K,{extensions:y,req:c,res:f,...a.security&&{security:a.security}});if(f.headersSent)return;let h=v instanceof C?v:new C({body:v}),E=h.payload.status??(s==="post"?201:200),S=a.responses[E]||a.responses.default;if(!S||typeof S=="boolean"||typeof S=="string")throw e?.logger?.error?.(`There is no corresponding validator defined in schema for status ${E}/default`),new Error("Internal server error");if(h.payload.body instanceof le.Readable||h.payload.body instanceof k.ReadStream)f.writeHead(E,h.payload.headers),h.payload.body.pipe(f);else{let b=await S.body.parseAsync(h.payload.body);if(typeof b>"u")f.writeHead(E,h.payload.headers).end();else{let _=await S.serialize(b);f.writeHead(E,{"content-type":S.mimeType,..._.headers,...h.payload.headers}).end(_.buffer)}}}catch(d){let g,y,i={};d instanceof H?(g=d.status,y=d.message,i=d.headers??{}):d instanceof I?(g=d.statusCode,y=d.message):d instanceof N?(g=400,y=d.errors):d instanceof he.z.ZodError?(g=500,y="Internal server error",e?.logger?.error?.("Invalid output format to the corresponding defined output schema"),e?.logger?.error?.(JSON.stringify(d))):d instanceof Error?(g=500,y=d.message,e?.logger?.error?.(String(d))):(g=500,y=String(d),e?.logger?.error?.(String(d))),f.writeHead(g,{"content-type":"application/json",...i}).end(JSON.stringify({statusCode:g,message:y}))}})}if(e?.docs){let n=JSON.stringify(e.docs.spec),a=k.readFileSync(me.join(__dirname,`./templates/${e.docs.viewer}.hbs`),"utf-8").replace("{{title}}",e.docs.spec.info.title).replace("{{specUrl}}",e.docs.specPath).replace("{{theme}}",e.docs.theme??"");t.get(e.docs.specPath,(s,p)=>{p.writeHead(200,{"content-type":"application/json"}).end(n)}),t.get(e.docs.docsPath,(s,p)=>{p.writeHead(200,{"content-type":"text/html"}).end(a)})}t.use(async(n,a)=>{if(await e?.fallbackHandler?.(n,a),a.headersSent)return;let{pathname:s}=ye.parse(n.url||"",!0);a.writeHead(404,{"content-type":"application/json"}).end(JSON.stringify({statusCode:404,message:`Cannot find ${n.method} ${s}`}))})}var Te=require("radash"),U=x(require("zod"));var Y=["get","post","put","patch","delete"];function He(t){return{...t,...t.requestBody&&!(t.requestBody instanceof A)&&{requestBody:new R(t.requestBody)},responses:Object.fromEntries(Object.entries(t.responses).map(([r,e])=>[r,e instanceof U.default.ZodType?new R(e):e]))}}var C=class t{constructor(r){this.payload=r}static withoutBody(r,e){return e?new t({headers:e,status:r}):new t({status:r})}},ee=class{name;schema;handler;constructor(r){this.name=r.name,this.schema=r.schema,this.handler=r.handler}apply(r){return new $(this,r)}},$=class{scopes;security;constructor(r,e){this.scopes=e,this.security=r}async authenticate(r,e){await this.security.handler(r,this.scopes,e)}},H=class extends Error{constructor(e,o,n){super(o);this.status=e;this.msg=o;this.headers=n}},A=class{_description=null;_headers=null;_examples=null;describe(r){return this._description=r,this}get description(){return this._description}requireHeaders(r){return this._headers=r,this}get requiredHeaders(){return this._headers}setExamples(r){return this._examples=r,this}getExamples(){return this._examples}},R=class t extends A{constructor(e){super();this.body=e}static mimeType="application/json";async serialize(e){return{buffer:Buffer.from(JSON.stringify(e)),headers:{}}}get mimeType(){return t.mimeType}},D=class t extends A{constructor(e,o){super();this.body=e;this.encoding=o}static mimeType="multipart/form-data";async serialize(e){let o=Q();return{buffer:await ae((0,Te.mapValues)(e,n=>[n instanceof File?n:String(n)]),o),headers:{"content-type":`${t.mimeType}; boundary=${o}`}}}get mimeType(){return t.mimeType}},q=class t extends A{constructor(e,o){super();this.body=e;this.encoding=o}static mimeType="application/x-www-form-urlencoded";async serialize(e){return{buffer:Buffer.from(new URLSearchParams(e instanceof URLSearchParams?e:Object.fromEntries(Object.entries(e).map(([o,n])=>[o,String(n)]))).toString()),headers:{}}}get mimeType(){return t.mimeType}},z=class t extends A{constructor(e=U.default.instanceof(Buffer)){super();this.body=e}static mimeType="application/octet-stream";async serialize(e){return{buffer:e,headers:{}}}get mimeType(){return t.mimeType}},G=class t extends A{constructor(e=U.default.string()){super();this.body=e}static mimeType="text/plain";async serialize(e){return{buffer:Buffer.from(e),headers:{}}}get mimeType(){return t.mimeType}},te=class t extends G{static mimeType="text/html";get mimeType(){return t.mimeType}};var Z=x(require("http-status")),l=require("radash"),u=require("zod");var Re=x(require("zod-to-json-schema")),J="GeneralApiError",be="ValidationError",qe=u.z.object({code:u.z.enum(["invalid_type","invalid_literal","unrecognized_keys","invalid_union","invalid_union_discriminator","invalid_enum_value","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite","custom"]),path:u.z.union([u.z.string(),u.z.number().int().min(0)]).array(),fatal:u.z.boolean().optional(),message:u.z.string()}).passthrough(),Ze=u.z.object({in:u.z.enum(["body","queries","params","headers","cookies"]).describe("The part of a request where data validation failed"),result:u.z.array(qe).describe("An array of error items")}),Pe=u.z.object({statusCode:u.z.number().int().min(100).max(599).describe("The HTTP response status code"),message:u.z.string().describe("The message associated with the error")}).describe("A general HTTP error response"),Ve=Pe.extend({message:u.z.union([u.z.array(Ze).describe("An array of error schemas detailing validation issues"),u.z.string().describe("Alternatively, a simple error message")])}).describe("An error related to the validation process with more detailed information"),Me=["https://spec.openapis.org/oas/3.1/dialect/base","https://spec.openapis.org/oas/3.1/dialect/2024-11-10"];function Le(t){let r={},e=new Set,o=new Set,n={};for(let[a,s]of Object.entries(t.paths)){if(s.hidden)continue;let[p,...m]=a.split(":"),{path:c}=ue(m.join(":")),f=[],d=r[c]??{};for(let i of s.security??[])e.add(i.security);for(let i of s.tags??[])o.add(i);for(let[i,P]of Object.entries(s.parameters??{})){let{properties:K={},required:v=[]}=w(P);for(let[h,E]of Object.entries(K)){if("$ref"in E)continue;let{description:S,...b}=E,_=v.includes(h);f.push({name:h,in:i,...S&&{description:S},..._&&{required:_},schema:b})}}let g=`${(0,l.pascal)((0,l.title)(s.operationId))}RequestBody`;s.requestBody&&s.requestBody.body._def.typeName!==u.z.ZodVoid.name&&!(s.requestBody instanceof z)&&(n[g]=w(s.requestBody.body,s.requestBody.mimeType));let y=`${(0,l.pascal)((0,l.title)(s.operationId))}Response`;for(let[,i]of Object.entries(s.responses??{}))i instanceof z||typeof i=="object"&&i.body._def.typeName!==u.z.ZodVoid.name&&(n[y]=w(i.body,i.mimeType));d[p]={...s.tags?.length&&{tags:Object.values(s.tags).map(i=>i.name)},summary:s.summary||s.operationId,...s.description&&{description:s.description},operationId:s.operationId,...s.deprecated&&{deprecated:s.deprecated},...!(0,l.isEmpty)(f)&&{parameters:f},...s.security?.length&&{security:s.security.map(i=>({[i.security.name]:i.scopes}))},...s.requestBody&&{requestBody:{...s.requestBody.description&&{description:s.requestBody.description},content:j(s.requestBody.mimeType,g,s.requestBody.body._def.typeName===u.z.ZodVoid.name||s.requestBody instanceof z,s.requestBody instanceof D||s.requestBody instanceof q?s.requestBody.encoding:void 0),required:!s.requestBody.body.isOptional()}},responses:{...(0,l.mapValues)((0,l.shake)(s.responses),(i,P)=>({description:(typeof i=="string"?i:null)||String(Z.default[`${P}`])||"No description",content:typeof i=="boolean"||typeof i=="string"?j(R.mimeType,J):j(i.mimeType,y,i.body._def.typeName===u.z.ZodVoid.name||i instanceof z)})),...(s.requestBody||!(0,l.isEmpty)(s.parameters))&&{400:{description:re(s.responses,400)||Z.default[400],content:j(R.mimeType,be)}},...s.security?.length&&{401:{description:re(s.responses,401)||Z.default[401],content:j(R.mimeType,J)}},500:{description:re(s.responses,500)||Z.default[500],content:j(R.mimeType,J)}}},r[c]=d}return{openapi:t.openapi,info:t.info,jsonSchemaDialect:t.jsonSchemaDialect??Me[0],paths:r,...t.webhooks&&{webhooks:t.webhooks},components:{schemas:{...n,[J]:w(Pe),[be]:w(Ve),...(0,l.mapEntries)(t.additionalSchemas??{},(a,s)=>[(0,l.pascal)((0,l.title)(a)),w(s)])},...e.size&&{securitySchemes:Object.fromEntries([...e.values()].map(a=>[a.name,a.schema]))}},tags:[...o.values()],...t.externalDocs&&{externalDocs:t.externalDocs}}}function j(t,r,e,o){return e?{[t]:{}}:{[t]:{schema:{$ref:`#/components/schemas/${r}`},...o&&{encoding:(0,l.mapValues)(o,n=>({...n,...n.contentType&&{contentType:n.contentType.join(", ")},...n.headers&&{headers:w(n.headers).properties}}))}}}}function re(t,r){let e=t[r];return typeof e=="string"?e:null}function w(t,r){let e=(0,Re.default)(t,{target:"jsonSchema2019-09",$refStrategy:"none"});if(r===D.mimeType)for(let o in e.properties??{})e.properties&&(0,l.isEmpty)(e.properties[o])&&(e.properties[o]={type:"string",format:"binary",contentMediaType:"application/octet-stream"});return delete e.$schema,e}var F=require("radash");function ke(t,r){let e=[],o=[];for(let n of r){let a=Object.keys(n).map(s=>L(`${t}${s}`));o.push(...e.filter(s=>a.includes(s))),e.push(...a)}if(o.length)throw new Error(`Duplicated keys occured: ${o.join(", ")}`);return(0,F.mapKeys)(Object.assign({},...r),n=>L(n.replace(/:/,`:${t}`)))}function $e(t,r){return(0,F.mapValues)(t,e=>(r.tags&&(e.tags?e.tags.push(...r.tags):e.tags=r.tags.slice()),r.security&&(e.security?e.security.push(...r.security):e.security=r.security.slice()),typeof r.hidden<"u"&&typeof e.hidden>"u"&&(e.hidden=r.hidden),typeof r.deprecated<"u"&&typeof e.deprecated>"u"&&(e.deprecated=r.deprecated),e))}0&&(module.exports={ApiError,AppliedSecurity,FormDataBody,HtmlBody,HttpResponse,JsonBody,METHODS,OctetStreamBody,Security,TextBody,UrlEncodedBody,applyGroupConfig,buildJson,createApi,endpoint,mergeEndpointGroups,oas3,...require("@routejs/router")});
//# sourceMappingURL=index.js.map