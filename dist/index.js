"use strict";var Ae=Object.create;var v=Object.defineProperty;var ze=Object.getOwnPropertyDescriptor;var _e=Object.getOwnPropertyNames;var we=Object.getPrototypeOf,Ce=Object.prototype.hasOwnProperty;var De=(t,r)=>()=>(r||t((r={exports:{}}).exports,r),r.exports),je=(t,r)=>{for(var e in r)v(t,e,{get:r[e],enumerable:!0})},Z=(t,r,e,s)=>{if(r&&typeof r=="object"||typeof r=="function")for(let o of _e(r))!Ce.call(t,o)&&o!==e&&v(t,o,{get:()=>r[o],enumerable:!(s=ze(r,o))||s.enumerable});return t},S=(t,r,e)=>(Z(t,r,"default"),e&&Z(e,r,"default")),x=(t,r,e)=>(e=t!=null?Ae(we(t)):{},Z(r||!t||!t.__esModule?v(e,"default",{value:t,enumerable:!0}):e,t)),Ne=t=>Z(v({},"__esModule",{value:!0}),t);var pe=De(B=>{"use strict";B.__esModule=!0;B.OpenAPIV2=B.OpenAPIV3=void 0;var qe;(function(t){var r;(function(e){e.GET="get",e.PUT="put",e.POST="post",e.DELETE="delete",e.OPTIONS="options",e.HEAD="head",e.PATCH="patch",e.TRACE="trace"})(r=t.HttpMethods||(t.HttpMethods={}))})(qe=B.OpenAPIV3||(B.OpenAPIV3={}));var Me;(function(t){var r;(function(e){e.GET="get",e.PUT="put",e.POST="post",e.DELETE="delete",e.OPTIONS="options",e.HEAD="head",e.PATCH="patch"})(r=t.HttpMethods||(t.HttpMethods={}))})(Me=B.OpenAPIV2||(B.OpenAPIV2={}))});var b={};je(b,{ApiError:()=>N,AppliedSecurity:()=>$,FormDataBody:()=>C,HtmlBody:()=>se,HttpResponse:()=>w,JsonBody:()=>R,METHODS:()=>re,OctetStreamBody:()=>A,Security:()=>ne,TextBody:()=>k,UrlEncodedBody:()=>M,applyGroupConfig:()=>Ke,buildJson:()=>Ue,createApi:()=>He,endpoint:()=>Le,mergeEndpointGroups:()=>Je,oas3:()=>Oe.OpenAPIV3_1});module.exports=Ne(b);S(b,require("@routejs/router"),module.exports);var Oe=x(pe());var L=x(require("fs")),Te=x(require("path")),be=require("stream"),te=x(require("url")),Re=x(require("cors")),Pe=require("radash");var ee=require("fast-content-type-parse");var de=require("crypto");function ce(t,r){let e="",s=0,o=[],a=[],n=[],u={};for(let p=0;p<t.length;p++){let c=t[p]??NaN,f=p>0?t[p-1]??null:null,d=c===10&&f===13;if(c===10||c===13||(e+=String.fromCharCode(c)),s===0&&d)`--${r}`===e&&(s=1),e="";else if(s===1&&d)e.length?n.push(e):(u=Object.fromEntries(n.flatMap(y=>{let[i,P=""]=y.split(":");return i?.trim()?[[i.trim().toLowerCase(),P?.trim()]]:[]})),s=2,o=[]),e="";else if(s===2){if(e.length>r.length+4&&(e=""),`--${r}`===e){let y=o.length-e.length,i=o.slice(0,y-1);a.push(Ve({headers:u,part:i})),o=[],n=[],u={},e="",s=3}else o.push(c);d&&(e="")}else s===3&&d&&(s=1)}return a}function Ve(t){let r=Ze(t.headers["content-disposition"]??"");return{headers:t.headers,name:r.name,data:Buffer.from(t.part),...r.filename&&{filename:r.filename,type:t.headers["content-type"]?.trim()}}}function Ze(t){let r={type:null,name:null,filename:null},e=t.split(";").map(s=>s.trim());e[0]&&(r.type=e[0].toLowerCase());for(let s of e.slice(1)){let[o,a]=s.split("=").map(n=>n.trim());o&&a&&(r[o.toLowerCase()]=a.replace(/^"|"$/g,""))}return r}function Y(t="----------------------"){return`--${t}${(0,de.randomBytes)(12).toString("hex")}`}async function ue(t,r=Y()){let e=[];for(let[s,o]of Object.entries(t))for(let a of o)e.push(Buffer.from(`--${r}`)),typeof a=="string"?e.push(Buffer.from(`Content-Disposition: form-data; name="${s}"\r
\r
`),Buffer.from(a),Buffer.from(`\r
`)):a instanceof File&&e.push(Buffer.from(`Content-Disposition: form-data; name="${s}"; filename="${a.name}"\r
`),Buffer.from(`Content-Type: ${a.type||"application/octet-stream"}\r
\r
`),Buffer.from(await a.arrayBuffer()),Buffer.from(`\r
`));return e.push(Buffer.from(`--${r}--\r
`)),Buffer.concat(e)}var O=class extends Error{constructor(r,e){super(e),this.statusCode=r}};function le(t){return new Promise((r,e)=>{let s=[];t.on("data",o=>s.push(o)),t.on("end",()=>r(Buffer.concat(s))),t.on("error",o=>e(o))})}function me(t,r,e){let s;try{s=(0,ee.parse)(r??"")}catch(o){throw new O(400,String(o))}if(t.length)if(s.type==="application/json")try{return JSON.parse(t.toString(s.parameters.charset??"utf-8"))}catch(o){throw new O(400,String(o))}else if(s.type==="multipart/form-data"){let o=s.parameters.boundary?.trim().replace(/^["']|["']$/g,"");if(!o)throw new O(400,"Cannot find multipart boundary");let a=ce(t,o),n={},u={};for(let p of a){let c=p.headers["content-type"],f=c?(0,ee.parse)(c):null;if(!p.name)continue;let d=p.filename?new File([p.data],p.filename,p.type?{type:p.type}:{}):p.data.toString(f?.parameters.charset??"utf-8");e?.multiValueFormData?(n[p.name]??=[]).push(d):u[p.name]=d}return e?.multiValueFormData?n:u}else if(s.type==="application/x-www-form-urlencoded"){let o=t.toString(s.parameters.charset??"utf-8"),a=new URLSearchParams(o),n={},u={};for(let[p,c]of a.entries())e?.multiValueUrlEncoded?(n[p]??=[]).push(c):u[p]=c;return e?.multiValueUrlEncoded?n:u}else{if(s.type==="application/octet-stream")return t;{let o=`'${s.type}' content type is not supported`;throw new O(415,o)}}else return}function ye(t){return t.split(";").reduce((r,e)=>{let[s,...o]=e.trim().split("=");return s&&(r[s]=decodeURIComponent(o.join("="))),r},{})}var j=class extends Error{constructor(){super();this.errors=[]}addIssue(e){this.errors.push(e)}hasIssue(){return this.errors.length>0}};function fe(t,r){let e=new j,s=r.requestBody?.body.safeParse(t.body);s?.error&&e.addIssue({in:"body",result:s.error.errors});let o=r.parameters?.query?.safeParse(t.queries);o?.error&&e.addIssue({in:"queries",result:o.error.errors});let a=r.parameters?.path?.safeParse(t.params);a?.error&&e.addIssue({in:"params",result:a.error.errors});let n=r.parameters?.header?.safeParse(t.headers);n?.error&&e.addIssue({in:"headers",result:n.error.errors});let u=r.parameters?.cookie?.safeParse(t.cookies);if(u?.error&&e.addIssue({in:"cookies",result:u.error.errors}),e.hasIssue())throw e;return{body:s?.data,queries:o?.data??{},params:a?.data??{},headers:n?.data??{},cookies:u?.data??{}}}function he(t,r,e,s){typeof s=="string"&&console.error(s?`[error:${s}]: ${e}`:`[error]: ${e}`),t.writeHead(r,{"content-type":"application/json"}).end(JSON.stringify({statusCode:r,message:e}))}function ge(t){let r=/:([^/]+)/g,e=H(t).replace(r,"{$1}"),s=[],o=null;for(;(o=r.exec(t))!==null;)s.push(o[1]);return{path:e,params:s}}function H(t){return t.replace(/\/+/gi,"/")}function He(t,r,e){e?.cors&&t.use((0,Re.default)(typeof e.cors=="boolean"?{}:e.cors)),console.log(`[server]: Registering ${Object.keys(r).length} endpoints...`);let s=new Set;for(let[o,a]of Object.entries(r)){let[n="",...u]=o.split(":"),p=u.join(":");if(s.has(a.operationId))throw new Error(`Duplicate operation ID "${a.operationId}" for path ${p}`);if(s.add(a.operationId),!re.some(c=>c===n))throw new Error(`Invalid method "${n}" for path ${p}`);console.log(`[register]: ${a.operationId} -> ${n.toUpperCase()} ${p}`),t[n](p,async(c,f)=>{try{let d=await le(c),h=me(d,c.headers["content-type"]??""),y={};if(a.security?.length)for(let T of a.security)await T.authenticate(c,y);let i=fe({body:h,queries:(0,Pe.mapValues)(te.parse(c.url||"",!0).query,T=>e?.request?.multiValueQueryString?T?.at(-1):T),cookies:ye(c.headers.cookie??""),params:c.params,headers:c.headers},a),P=await a.handler(i,{extensions:y,req:c,res:f,...a.security&&{security:a.security}}),g=P instanceof w?P:new w({body:P}),z=g.payload.status??(n==="post"?201:200);if(f.headersSent)return;let E=a.responses[z]||a.responses.default;if(!E||typeof E=="boolean"||typeof E=="string")throw console.error(`[error]: There is no corresponding validator defined in schema for status ${z}/default`),new Error("Internal server error");try{E.body.parse(g.payload.body)}catch(T){throw console.error("[error]: Invalid output format to the corresponding defined output schema"),console.error(String(T)),new Error("Internal server error")}if(g.payload.body instanceof be.Readable||g.payload.body instanceof L.ReadStream)f.writeHead(z,g.payload.headers),g.payload.body.pipe(f);else if(typeof g.payload.body>"u")f.writeHead(z,g.payload.headers).end();else{let T=await E.serialize(g.payload.body);f.writeHead(z,{"content-type":E.mimeType,...T.headers,...g.payload.headers}).end(T.buffer)}}catch(d){let h,y;d instanceof N?(h=d.status,y=d.message):d instanceof O?(h=d.statusCode,y=d.message):d instanceof j?(h=400,y=d.errors):d instanceof Error?(h=500,y=d.message,console.error(String(d))):(h=500,y=String(d),console.error(String(d))),f.writeHead(h,{"content-type":"application/json"}).end(JSON.stringify({statusCode:h,message:y}))}})}if(e?.docs){let o=JSON.stringify(e.docs.spec),a=L.readFileSync(Te.join(__dirname,`./templates/${e.docs.viewer}.hbs`),"utf-8").replace("{{title}}",e.docs.spec.info.title).replace("{{specUrl}}",e.docs.specPath).replace("{{theme}}",e.docs.theme??"");t.get(e.docs.specPath,(n,u)=>{u.writeHead(200,{"content-type":"application/json"}).end(o)}),t.get(e.docs.docsPath,(n,u)=>{u.writeHead(200,{"content-type":"text/html"}).end(a)})}t.use(async(o,a)=>{if(await e?.fallbackHandler?.(o,a),a.headersSent)return;let{pathname:n}=te.parse(o.url||"",!0);he(a,404,`Cannot find ${o.method} ${n}`)})}var Ee=require("radash"),Q=x(require("zod"));var re=["get","post","put","patch","delete"];function Le(t){return{...t,...t.requestBody&&!(t.requestBody instanceof I)&&{requestBody:new R(t.requestBody)},responses:Object.fromEntries(Object.entries(t.responses).map(([r,e])=>[r,e instanceof Q.default.ZodType?new R(e):e]))}}var w=class t{constructor(r){this.payload=r}static withoutBody(r,e){return e?new t({headers:e,status:r}):new t({status:r})}},ne=class{constructor(r){this.name=r.name,this.schema=r.schema,this.handler=r.handler}apply(r){return new $(this,r)}},$=class{constructor(r,e){this.scopes=e,this.security=r}async authenticate(r,e){await this.security.handler(r,this.scopes,e)}},N=class extends Error{constructor(e,s){super(s);this.status=e;this.msg=s}},I=class{constructor(){this._description=null;this._headers=null;this._examples=null}describe(r){return this._description=r,this}get description(){return this._description}requireHeaders(r){return this._headers=r,this}get requiredHeaders(){return this._headers}setExamples(r){return this._examples=r,this}getExamples(){return this._examples}},G=class G extends I{constructor(e){super();this.body=e}async serialize(e){return{buffer:Buffer.from(JSON.stringify(e)),headers:{}}}get mimeType(){return G.mimeType}};G.mimeType="application/json";var R=G,q=class q extends I{constructor(e,s){super();this.body=e;this.encoding=s}async serialize(e){let s=Y();return{buffer:await ue((0,Ee.mapValues)(e,o=>[o instanceof File?o:String(o)]),s),headers:{"content-type":`${q.mimeType}; boundary=${s}`}}}get mimeType(){return q.mimeType}};q.mimeType="multipart/form-data";var C=q,F=class F extends I{constructor(e,s){super();this.body=e;this.encoding=s}async serialize(e){return{buffer:Buffer.from(new URLSearchParams(e instanceof URLSearchParams?e:Object.fromEntries(Object.entries(e).map(([s,o])=>[s,String(o)]))).toString()),headers:{}}}get mimeType(){return F.mimeType}};F.mimeType="application/x-www-form-urlencoded";var M=F,U=class U extends I{constructor(e=Q.default.instanceof(Buffer)){super();this.body=e}async serialize(e){return{buffer:e,headers:{}}}get mimeType(){return U.mimeType}};U.mimeType="application/octet-stream";var A=U,J=class J extends I{constructor(e=Q.default.string()){super();this.body=e}async serialize(e){return{buffer:Buffer.from(e),headers:{}}}get mimeType(){return J.mimeType}};J.mimeType="text/plain";var k=J,K=class K extends k{get mimeType(){return K.mimeType}};K.mimeType="text/html";var se=K;var V=x(require("http-status")),m=require("radash"),l=require("zod");var xe=x(require("zod-to-json-schema")),W="GeneralApiError",Se="ValidationError",$e=l.z.object({code:l.z.enum(["invalid_type","invalid_literal","unrecognized_keys","invalid_union","invalid_union_discriminator","invalid_enum_value","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite","custom"]),path:l.z.union([l.z.string(),l.z.number().int().min(0)]).array(),fatal:l.z.boolean().optional(),message:l.z.string()}).passthrough(),ke=l.z.object({in:l.z.enum(["body","queries","params","headers","cookies"]).describe("The part of a request where data validation failed"),result:l.z.array($e).describe("An array of error items")}),Be=l.z.object({statusCode:l.z.number().int().min(100).max(599).describe("The HTTP response status code"),message:l.z.string().describe("The message associated with the error")}).describe("A general HTTP error response"),Ge=Be.extend({message:l.z.union([l.z.array(ke).describe("An array of error schemas detailing validation issues"),l.z.string().describe("Alternatively, a simple error message")])}).describe("An error related to the validation process with more detailed information"),Fe=["https://spec.openapis.org/oas/3.1/dialect/base","https://spec.openapis.org/oas/3.1/dialect/2024-11-10"];function Ue(t){let r={},e=new Set,s=new Set,o={};for(let[a,n]of Object.entries(t.paths)){let[u,...p]=a.split(":"),{path:c}=ge(p.join(":")),f=[],d=r[c]??{};for(let i of n.security??[])e.add(i.security);for(let i of n.tags??[])s.add(i);for(let[i,P]of Object.entries(n.parameters??{})){let{properties:g={},required:z=[]}=_(P);for(let[E,T]of Object.entries(g)){if("$ref"in T)continue;let{description:ae,...Ie}=T,ie=z.includes(E);f.push({name:E,in:i,...ae&&{description:ae},...ie&&{required:ie},schema:Ie})}}let h=`${(0,m.pascal)((0,m.title)(n.operationId))}RequestBody`;n.requestBody&&n.requestBody.body._def.typeName!==l.z.ZodVoid.name&&!(n.requestBody instanceof A)&&(o[h]=_(n.requestBody.body,n.requestBody.mimeType));let y=`${(0,m.pascal)((0,m.title)(n.operationId))}Response`;for(let[,i]of Object.entries(n.responses??{}))i instanceof A||typeof i=="object"&&i.body._def.typeName!==l.z.ZodVoid.name&&(o[y]=_(i.body,i.mimeType));d[u]={...n.tags?.length&&{tags:Object.values(n.tags).map(i=>i.name)},summary:n.summary||n.operationId,...n.description&&{description:n.description},operationId:n.operationId,...n.deprecated&&{deprecated:n.deprecated},...!(0,m.isEmpty)(f)&&{parameters:f},...n.security?.length&&{security:n.security.map(i=>({[i.security.name]:i.scopes}))},...n.requestBody&&{requestBody:{...n.requestBody.description&&{description:n.requestBody.description},content:D(n.requestBody.mimeType,h,n.requestBody.body._def.typeName===l.z.ZodVoid.name||n.requestBody instanceof A,n.requestBody instanceof C||n.requestBody instanceof M?n.requestBody.encoding:void 0),required:!n.requestBody.body.isOptional()}},responses:{...(0,m.mapValues)((0,m.shake)(n.responses),(i,P)=>({description:(typeof i=="string"?i:null)||String(V.default[`${P}`])||"No description",content:typeof i=="boolean"||typeof i=="string"?D(R.mimeType,W):D(i.mimeType,y,i.body._def.typeName===l.z.ZodVoid.name||i instanceof A)})),...(n.requestBody||!(0,m.isEmpty)(n.parameters))&&{400:{description:oe(n.responses,400)||V.default[400],content:D(R.mimeType,Se)}},...n.security?.length&&{401:{description:oe(n.responses,401)||V.default[401],content:D(R.mimeType,W)}},500:{description:oe(n.responses,500)||V.default[500],content:D(R.mimeType,W)}}},r[c]=d}return{openapi:t.openapi,info:t.info,jsonSchemaDialect:t.jsonSchemaDialect??Fe[0],paths:r,...t.webhooks&&{webhooks:t.webhooks},components:{schemas:{...o,[W]:_(Be),[Se]:_(Ge),...(0,m.mapEntries)(t.additionalSchemas??{},(a,n)=>[(0,m.pascal)((0,m.title)(a)),_(n)])},...e.size&&{securitySchemes:Object.fromEntries([...e.values()].map(a=>[a.name,a.schema]))}},tags:[...s.values()],...t.externalDocs&&{externalDocs:t.externalDocs}}}function D(t,r,e,s){return e?{[t]:{}}:{[t]:{schema:{$ref:`#/components/schemas/${r}`},...s&&{encoding:(0,m.mapValues)(s,o=>({...o,...o.contentType&&{contentType:o.contentType.join(", ")},...o.headers&&{headers:_(o.headers).properties}}))}}}}function oe(t,r){let e=t[r];return typeof e=="string"?e:null}function _(t,r){let e=(0,xe.default)(t,{target:"jsonSchema2019-09",$refStrategy:"none"});if(r===C.mimeType)for(let s in e.properties??{})e.properties&&(0,m.isEmpty)(e.properties[s])&&(e.properties[s]={type:"string",contentMediaType:"application/octet-stream"});return delete e.$schema,e}var X=require("radash");function Je(t,r){let e=[],s=[];for(let o of r){let a=Object.keys(o).map(n=>H(`${t}${n}`));s.push(...e.filter(n=>a.includes(n))),e.push(...a)}if(s.length)throw new Error(`Duplicated keys occured: ${s.join(", ")}`);return(0,X.mapKeys)(Object.assign({},...r),o=>H(o.replace(/:/,`:${t}`)))}function Ke(t,r){return(0,X.mapValues)(t,e=>Object.assign(e,r))}0&&(module.exports={ApiError,AppliedSecurity,FormDataBody,HtmlBody,HttpResponse,JsonBody,METHODS,OctetStreamBody,Security,TextBody,UrlEncodedBody,applyGroupConfig,buildJson,createApi,endpoint,mergeEndpointGroups,oas3,...require("@routejs/router")});
//# sourceMappingURL=index.js.map