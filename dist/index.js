"use strict";var ze=Object.create;var V=Object.defineProperty;var _e=Object.getOwnPropertyDescriptor;var we=Object.getOwnPropertyNames;var je=Object.getPrototypeOf,Ne=Object.prototype.hasOwnProperty;var De=(t,r)=>()=>(r||t((r={exports:{}}).exports,r),r.exports),Ce=(t,r)=>{for(var e in r)V(t,e,{get:r[e],enumerable:!0})},L=(t,r,e,n)=>{if(r&&typeof r=="object"||typeof r=="function")for(let s of we(r))!Ne.call(t,s)&&s!==e&&V(t,s,{get:()=>r[s],enumerable:!(n=_e(r,s))||n.enumerable});return t},E=(t,r,e)=>(L(t,r,"default"),e&&L(e,r,"default")),P=(t,r,e)=>(e=t!=null?ze(je(t)):{},L(r||!t||!t.__esModule?V(e,"default",{value:t,enumerable:!0}):e,t)),ve=t=>L(V({},"__esModule",{value:!0}),t);var de=De(B=>{"use strict";B.__esModule=!0;B.OpenAPIV2=B.OpenAPIV3=void 0;var ke;(function(t){var r;(function(e){e.GET="get",e.PUT="put",e.POST="post",e.DELETE="delete",e.OPTIONS="options",e.HEAD="head",e.PATCH="patch",e.TRACE="trace"})(r=t.HttpMethods||(t.HttpMethods={}))})(ke=B.OpenAPIV3||(B.OpenAPIV3={}));var Ze;(function(t){var r;(function(e){e.GET="get",e.PUT="put",e.POST="post",e.DELETE="delete",e.OPTIONS="options",e.HEAD="head",e.PATCH="patch"})(r=t.HttpMethods||(t.HttpMethods={}))})(Ze=B.OpenAPIV2||(B.OpenAPIV2={}))});var f={};Ce(f,{ApiError:()=>C,AppliedSecurity:()=>$,FormDataBody:()=>A,HtmlBody:()=>ne,HttpResponse:()=>j,JsonBody:()=>T,METHODS:()=>oe,OctetStreamBody:()=>I,Security:()=>re,TextBody:()=>q,UrlEncodedBody:()=>v,ValidationError:()=>z,applyGroupConfig:()=>Qe,buildJson:()=>Ke,createApi:()=>qe,endpoint:()=>$e,mergeEndpointGroups:()=>We,oas3:()=>Ae.OpenAPIV3_1});module.exports=ve(f);E(f,require("@routejs/router"),module.exports);var Ae=P(de());var X=P(require("fs")),Re=P(require("path")),Oe=require("stream"),se=P(require("url")),Se=P(require("cors"));var he=require("radash");var ce=require("crypto");function me(t,r){let e="",n=0,s=[],i=[],o=[],u={};for(let d=0;d<t.length;d++){let p=t[d]??NaN,l=d>0?t[d-1]??null:null,b=p===10&&l===13;if(p===10||p===13||(e+=String.fromCharCode(p)),n===0&&b)`--${r}`===e&&(n=1),e="";else if(n===1&&b)e.length?o.push(e):(u=Object.fromEntries(o.flatMap(g=>{let[a,y=""]=g.split(":");return a?.trim()?[[a.trim().toLowerCase(),y?.trim()]]:[]})),n=2,s=[]),e="";else if(n===2){if(e.length>r.length+4&&(e=""),`--${r}`===e){let g=s.length-e.length,a=s.slice(0,g-1);i.push(He({headers:u,part:a})),s=[],o=[],u={},e="",n=3}else s.push(p);b&&(e="")}else n===3&&b&&(n=1)}return i}function ue(t){let r=t.split(";");for(let e of r){let n=String(e).trim();if(n.startsWith("boundary")){let s=n.split("=");return String(s[1]).trim().replace(/^["']|["']$/g,"")}}return null}function He(t){let r=Le(t.headers["content-disposition"]??"");return{headers:t.headers,name:r.name,data:Buffer.from(t.part),...r.filename&&{filename:r.filename,type:t.headers["content-type"]?.trim()}}}function Le(t){let r={type:null,name:null,filename:null},e=t.split(";").map(n=>n.trim());e[0]&&(r.type=e[0].toLowerCase());for(let n of e.slice(1)){let[s,i]=n.split("=").map(o=>o.trim());s&&i&&(r[s.toLowerCase()]=i.replace(/^"|"$/g,""))}return r}function te(t="----------------------"){return`--${t}${(0,ce.randomBytes)(12).toString("hex")}`}async function le(t,r=te()){let e=[];for(let[n,s]of Object.entries(t))for(let i of s)e.push(Buffer.from(`--${r}`)),typeof i=="string"?e.push(Buffer.from(`Content-Disposition: form-data; name="${n}"\r
\r
`),Buffer.from(i),Buffer.from(`\r
`)):i instanceof File&&e.push(Buffer.from(`Content-Disposition: form-data; name="${n}"; filename="${i.name}"\r
`),Buffer.from(`Content-Type: ${i.type||"application/octet-stream"}\r
\r
`),Buffer.from(await i.arrayBuffer()),Buffer.from(`\r
`));return e.push(Buffer.from(`--${r}--\r
`)),Buffer.concat(e)}var ye=require("radash"),K=P(require("zod"));var oe=["get","post","put","patch","delete"];function $e(t){return{...t,...t.requestBody&&!(t.requestBody instanceof x)&&{requestBody:new T(t.requestBody)},responses:Object.fromEntries(Object.entries(t.responses).map(([r,e])=>[r,e instanceof K.default.ZodType?new T(e):e]))}}var j=class t{constructor(r){this.payload=r}static withoutBody(r,e){return e?new t({headers:e,status:r}):new t({status:r})}},re=class{constructor(r){this.name=r.name,this.schema=r.schema,this.handler=r.handler}apply(r){return new $(this,r)}},$=class{constructor(r,e){this.scopes=e,this.security=r}async authenticate(r,e){await this.security.handler(r,this.scopes,e)}},C=class extends Error{constructor(e,n){super(n);this.status=e;this.msg=n}},z=class extends Error{constructor(e){super(JSON.stringify(e));this.msg=e}},x=class{constructor(){this._description=null;this._headers=null;this._examples=null}describe(r){return this._description=r,this}get description(){return this._description}requireHeaders(r){return this._headers=r,this}get requiredHeaders(){return this._headers}setExamples(r){return this._examples=r,this}getExamples(){return this._examples}},M=class M extends x{constructor(e){super();this.body=e}async serialize(e){return Buffer.from(JSON.stringify(e))}get mimeType(){return M.mimeType}};M.mimeType="application/json";var T=M,D=class D extends x{constructor(e,n){super();this.body=e;this.encoding=n}async serialize(e){return(await this.serializeWithContentType(e))[1]}async serializeWithContentType(e){let n=te();return[`${D.mimeType}; boundary=${n}`,await le((0,ye.mapValues)(e,s=>[s instanceof File?s:String(s)]),n)]}get mimeType(){return D.mimeType}};D.mimeType="multipart/form-data";var A=D,G=class G extends x{constructor(e,n){super();this.body=e;this.encoding=n}async serialize(e){return Buffer.from(new URLSearchParams(e instanceof URLSearchParams?e:Object.fromEntries(Object.entries(e).map(([n,s])=>[n,String(s)]))).toString())}get mimeType(){return G.mimeType}};G.mimeType="application/x-www-form-urlencoded";var v=G,J=class J extends x{constructor(e=K.default.instanceof(Buffer)){super();this.body=e}async serialize(e){return e}get mimeType(){return J.mimeType}};J.mimeType="application/octet-stream";var I=J,U=class U extends x{constructor(e=K.default.string()){super();this.body=e}async serialize(e){return Buffer.from(e)}get mimeType(){return U.mimeType}};U.mimeType="text/plain";var q=U,F=class F extends q{get mimeType(){return F.mimeType}};F.mimeType="text/html";var ne=F;function fe(t,r){let e={},n=k(()=>r.requestBody?.body.parse(t.body)||t.body,d=>e.body=JSON.parse(d.message)),s=k(()=>r.parameters?.query?.parse(t.query)||t.query,d=>e.queries=JSON.parse(d.message)),i=k(()=>r.parameters?.path?.parse(t.params)||t.params,d=>e.params=JSON.parse(d.message)),o=k(()=>r.parameters?.header?.parse(t.headers)||t.headers,d=>e.headers=JSON.parse(d.message)),u=k(()=>r.parameters?.cookie?.parse(t.cookies)||t.cookies,d=>e.cookies=JSON.parse(d.message));if(Object.keys(e).length)throw new z(e);return{body:n??null,queries:s??{},params:i??{},headers:o??{},cookies:u??{}}}function R(t,r,e,n){typeof n=="string"&&console.error(n?`[error:${n}]: ${e}`:`[error]: ${e}`),t.writeHead(r,{"content-type":"application/json"}).end(JSON.stringify({statusCode:r,message:e}))}function ge(t){let r=/:([^/]+)/g,e=W(t).replace(r,"{$1}"),n=[],s=null;for(;(s=r.exec(t))!==null;)n.push(s[1]);return{path:e,params:n}}function W(t){return t.replace(/\/+/gi,"/")}function k(t,r){try{return t()}catch(e){return r(e),null}}function Te(t,r,e){let n=[];t.on("data",s=>n.push(s)),t.on("end",async()=>{if(t.method==="GET"||!n.length)return e();if(t.headers["content-type"]==="application/json"){let s=Buffer.concat(n);try{s.length&&Object.assign(t,{body:JSON.parse(s.toString("utf-8"))})}catch{return R(r,400,"Invalid JSON")}return e()}else if(t.headers["content-type"]?.startsWith("multipart/form-data")){let s=Buffer.concat(n),i=ue(t.headers["content-type"]);if(!i)return R(r,400,"Cannot find multipart boundary");let o=me(s,i),u={};for(let p of o){if(!p.name)continue;let l=p.filename?new File([p.data],p.filename,p.type?{type:p.type}:{}):p.data.toString("utf-8");(u[p.name]??=[]).push(l)}let d=[];for(let[p,l=[]]of Object.entries(u))l.length>1&&d.push({field:p,message:"Duplicated key"});return d.length?R(r,400,JSON.stringify({in:"body",result:d.map(({field:p,message:l})=>({path:[p],message:l}))})):(Object.assign(t,{body:(0,he.mapValues)(u,p=>p[0])}),e())}else if(t.headers["content-type"]==="application/x-www-form-urlencoded"){let s=Buffer.concat(n).toString("utf-8"),i=new URLSearchParams(s),o=[];return Array.from(i.keys()).reduce((u,d)=>(u.has(d)&&o.push(d),u.add(d)),new Set),o.length?R(r,400,JSON.stringify({in:"body",result:o.map(u=>({path:[u],message:"Duplicated key"}))})):(Object.assign(t,{body:Object.fromEntries(i)}),e())}else return t.headers["content-type"]==="application/octet-stream"?(Object.assign(t,{body:Buffer.concat(n)}),e()):R(r,415,`'${t.headers["content-type"]}' content type is not supported`)}),t.on("error",s=>{R(r,500,String(s))})}function be(t=""){return t.split(";").reduce((r,e)=>{let[n,...s]=e.trim().split("=");return n&&(r[n]=decodeURIComponent(s.join("="))),r},{})}var Q={"content-type":"application/json"};function qe(t,r,e){e?.cors&&t.use((0,Se.default)(typeof e.cors=="boolean"?{}:e.cors)),t.use(Te),console.log(`[server]: Registering ${Object.keys(r).length} endpoints...`);let n=new Set;for(let[s,i]of Object.entries(r)){let[o="",...u]=s.split(":"),d=u.join(":");if(n.has(i.operationId))throw new Error(`Duplicate operation ID "${i.operationId}" for path ${d}`);if(n.add(i.operationId),!oe.some(p=>p===o))throw new Error(`Invalid method "${o}" for path ${d}`);console.log(`[register]: ${i.operationId} -> ${o.toUpperCase()} ${d}`),t[o](d,async(p,l)=>{let b=se.parse(p.url||"",!0);Object.assign(p,{query:b.query,cookies:be(p.headers.cookie)});let w={};try{if(i.security?.length)for(let S of i.security)await S.authenticate(p,w);let g=fe(p,i),a=await i.handler(g,w),y=a instanceof j?a:new j({body:a}),O=y.payload.status??(o==="post"?201:200),h=i.responses[O]||i.responses.default;if(!h||typeof h=="boolean"||typeof h=="string")throw console.error(`[error]: There is no corresponding validator defined in schema for status ${O}/default`),new Error("Internal server error");try{h.body.parse(y.payload.body)}catch(S){throw console.error("[error]: Invalid output format to the corresponding defined output schema"),console.error(String(S)),new Error("Internal server error")}if(y.payload.body instanceof Oe.Readable||y.payload.body instanceof X.ReadStream)l.writeHead(O,y.payload.headers),y.payload.body.pipe(l);else if(typeof y.payload.body>"u")l.writeHead(O,y.payload.headers).end();else if(h instanceof A){let[S,H]=await h.serializeWithContentType(y.payload.body);l.writeHead(O,{"content-type":S,...y.payload.headers}).end(H)}else l.writeHead(O,{"content-type":h.mimeType,...y.payload.headers}).end(await h.serialize(y.payload.body))}catch(g){Me(g,l)}})}e?.docs&&Ge(t,e.docs),t.use(async(s,i)=>{if(await e?.fallbackHandler?.(s,i)??Promise.resolve(null),i.headersSent)return;let{pathname:o}=se.parse(s.url||"",!0);R(i,404,`Cannot find ${s.method} ${o}`)})}function Me(t,r){t instanceof C?r.writeHead(t.status,Q).end(JSON.stringify({statusCode:t.status,message:t.message})):t instanceof z?r.writeHead(400,Q).end(JSON.stringify({statusCode:400,message:Object.entries(JSON.parse(t.message)).map(([e,n])=>({in:e,result:n}))})):t instanceof Error?(console.error(String(t)),r.writeHead(500,Q).end(JSON.stringify({statusCode:500,message:t.message}))):(console.error(String(t)),r.writeHead(500,Q).end(JSON.stringify({statusCode:500,message:String(t)})))}function Ge(t,r){let e=JSON.stringify(r.spec),n=X.readFileSync(Re.join(__dirname,`./templates/${r.viewer}.hbs`),"utf-8").replace("{{title}}",r.spec.info.title).replace("{{specUrl}}",r.specPath).replace("{{theme}}",r.theme??"");t.get(r.specPath,(s,i)=>{i.writeHead(200,{"content-type":"application/json"}).end(e)}),t.get(r.docsPath,(s,i)=>{i.writeHead(200,{"content-type":"text/html"}).end(n)})}var Z=P(require("http-status")),m=require("radash"),c=require("zod");var Pe=P(require("zod-to-json-schema")),Y="GeneralApiError",Ee="ValidationError",Je=c.z.object({code:c.z.enum(["invalid_type","invalid_literal","unrecognized_keys","invalid_union","invalid_union_discriminator","invalid_enum_value","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite","custom"]),path:c.z.union([c.z.string(),c.z.number().int().min(0)]).array(),fatal:c.z.boolean().optional(),message:c.z.string()}).passthrough(),Ue=c.z.object({in:c.z.enum(["body","queries","params","headers","cookies"]).describe("The part of a request where data validation failed"),result:c.z.array(Je).describe("An array of error items")}),Be=c.z.object({statusCode:c.z.number().int().min(100).max(599).describe("The HTTP response status code"),message:c.z.string().describe("The message associated with the error")}).describe("A general HTTP error response"),Fe=Be.extend({message:c.z.union([c.z.array(Ue).describe("An array of error schemas detailing validation issues"),c.z.string().describe("Alternatively, a simple error message")])}).describe("An error related to the validation process with more detailed information"),xe=["https://json-schema.org/draft/2020-12/schema#","https://json-schema.org/draft/2019-09/schema#","https://json-schema.org/draft-07/schema#","https://json-schema.org/draft-06/schema#","http://json-schema.org/draft-04/schema#"];function Ke(t){let r={},e={},n=new Set,s=new Set;for(let[i,o]of Object.entries(t.paths)){let[u,...d]=i.split(":"),{path:p}=ge(d.join(":")),l=[],b=r[p]??{};for(let a of o.security??[])n.add(a.security);for(let a of o.tags??[])s.add(a);for(let[a,y]of Object.entries(o.parameters??{})){let{properties:O={},required:h=[]}=_(y);for(let[S,H]of Object.entries(O)){if("$ref"in H)continue;let{description:ae,...Ie}=H,pe=h.includes(S);l.push({name:S,in:a,...ae&&{description:ae},...pe&&{required:pe},schema:Ie})}}let w=`${(0,m.pascal)((0,m.title)(o.operationId))}RequestBody`;o.requestBody&&o.requestBody.body._def.typeName!==c.z.ZodVoid.name&&!(o.requestBody instanceof I)&&(e[w]=_(o.requestBody.body,o.requestBody.mimeType));let g=`${(0,m.pascal)((0,m.title)(o.operationId))}Response`;for(let[,a]of Object.entries(o.responses??{}))a instanceof I||typeof a=="object"&&a.body._def.typeName!==c.z.ZodVoid.name&&(e[g]=_(a.body,a.mimeType));b[u]={...o.tags?.length&&{tags:Object.values(o.tags).map(a=>a.name)},summary:o.summary||o.operationId,...o.description&&{description:o.description},operationId:o.operationId,...o.deprecated&&{deprecated:o.deprecated},...!(0,m.isEmpty)(l)&&{parameters:l},...o.security?.length&&{security:o.security.map(a=>({[a.security.name]:a.scopes}))},...o.requestBody&&{requestBody:{...o.requestBody.description&&{description:o.requestBody.description},content:N(o.requestBody.mimeType,w,o.requestBody.body._def.typeName===c.z.ZodVoid.name||o.requestBody instanceof I,o.requestBody instanceof A||o.requestBody instanceof v?o.requestBody.encoding:void 0),required:!o.requestBody.body.isOptional()}},responses:{...(0,m.mapValues)((0,m.shake)(o.responses),(a,y)=>({description:(typeof a=="string"?a:null)||String(Z.default[`${y}`])||"No description",content:typeof a=="boolean"||typeof a=="string"?N(T.mimeType,Y):N(a.mimeType,g,a.body._def.typeName===c.z.ZodVoid.name||a instanceof I)})),...(o.requestBody||!(0,m.isEmpty)(o.parameters))&&{400:{description:ie(o.responses,400)||Z.default[400],content:N(T.mimeType,Ee)}},...o.security?.length&&{401:{description:ie(o.responses,401)||Z.default[401],content:N(T.mimeType,Y)}},500:{description:ie(o.responses,500)||Z.default[500],content:N(T.mimeType,Y)}}},r[p]=b}return{openapi:t.openapi,info:t.info,jsonSchemaDialect:t.jsonSchemaDialect??xe[0],paths:r,...t.webhooks&&{webhooks:t.webhooks},components:{schemas:{...e,[Y]:_(Be),[Ee]:_(Fe),...(0,m.mapEntries)(t.additionalSchemas??{},(i,o)=>[(0,m.pascal)((0,m.title)(i)),_(o)])},...n.size&&{securitySchemes:Object.fromEntries([...n.values()].map(i=>[i.name,i.schema]))}},tags:[...s.values()],...t.externalDocs&&{externalDocs:t.externalDocs}}}function N(t,r,e,n){return e?{[t]:{}}:{[t]:{schema:{$ref:`#/components/schemas/${r}`},...n&&{encoding:(0,m.mapValues)(n,s=>({...s,...s.contentType&&{contentType:s.contentType.join(", ")},...s.headers&&{headers:_(s.headers).properties}}))}}}}function ie(t,r){let e=t[r];return typeof e=="string"?e:null}function _(t,r){let e=(0,Pe.default)(t,{target:"jsonSchema2019-09"});if(r===A.mimeType)for(let n in e.properties??{})e.properties&&(0,m.isEmpty)(e.properties[n])&&(e.properties[n]={type:"string",contentMediaType:"application/octet-stream"});return e.$schema=xe[0],e}var ee=require("radash");function We(t,r){let e=[],n=[];for(let s of r){let i=Object.keys(s).map(o=>W(`${t}${o}`));n.push(...e.filter(o=>i.includes(o))),e.push(...i)}if(n.length)throw new Error(`Duplicated keys occured: ${n.join(", ")}`);return(0,ee.mapKeys)(Object.assign({},...r),s=>W(s.replace(/:/,`:${t}`)))}function Qe(t,r){return(0,ee.mapValues)(t,e=>Object.assign(e,r))}0&&(module.exports={ApiError,AppliedSecurity,FormDataBody,HtmlBody,HttpResponse,JsonBody,METHODS,OctetStreamBody,Security,TextBody,UrlEncodedBody,ValidationError,applyGroupConfig,buildJson,createApi,endpoint,mergeEndpointGroups,oas3,...require("@routejs/router")});
//# sourceMappingURL=index.js.map