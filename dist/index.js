"use strict";var Be=Object.create;var L=Object.defineProperty;var xe=Object.getOwnPropertyDescriptor;var Ae=Object.getOwnPropertyNames;var Ie=Object.getPrototypeOf,ze=Object.prototype.hasOwnProperty;var _e=(t,r)=>()=>(r||t((r={exports:{}}).exports,r),r.exports),we=(t,r)=>{for(var e in r)L(t,e,{get:r[e],enumerable:!0})},Z=(t,r,e,o)=>{if(r&&typeof r=="object"||typeof r=="function")for(let s of Ae(r))!ze.call(t,s)&&s!==e&&L(t,s,{get:()=>r[s],enumerable:!(o=xe(r,s))||o.enumerable});return t},S=(t,r,e)=>(Z(t,r,"default"),e&&Z(e,r,"default")),E=(t,r,e)=>(e=t!=null?Be(Ie(t)):{},Z(r||!t||!t.__esModule?L(e,"default",{value:t,enumerable:!0}):e,t)),je=t=>Z(L({},"__esModule",{value:!0}),t);var ie=_e(B=>{"use strict";B.__esModule=!0;B.OpenAPIV2=B.OpenAPIV3=void 0;var De;(function(t){var r;(function(e){e.GET="get",e.PUT="put",e.POST="post",e.DELETE="delete",e.OPTIONS="options",e.HEAD="head",e.PATCH="patch",e.TRACE="trace"})(r=t.HttpMethods||(t.HttpMethods={}))})(De=B.OpenAPIV3||(B.OpenAPIV3={}));var Ne;(function(t){var r;(function(e){e.GET="get",e.PUT="put",e.POST="post",e.DELETE="delete",e.OPTIONS="options",e.HEAD="head",e.PATCH="patch"})(r=t.HttpMethods||(t.HttpMethods={}))})(Ne=B.OpenAPIV2||(B.OpenAPIV2={}))});var h={};we(h,{ApiError:()=>D,AppliedSecurity:()=>H,FormDataBody:()=>x,HtmlBody:()=>re,HttpResponse:()=>w,JsonBody:()=>R,METHODS:()=>ee,OctetStreamBody:()=>I,Security:()=>te,TextBody:()=>V,UrlEncodedBody:()=>C,applyGroupConfig:()=>Je,buildJson:()=>Me,createApi:()=>Ze,endpoint:()=>Le,mergeEndpointGroups:()=>Ge,oas3:()=>Se.OpenAPIV3_1});module.exports=je(h);S(h,require("@routejs/router"),module.exports);var Se=E(ie());var k=E(require("fs")),ge=E(require("path")),he=require("stream"),Y=E(require("url")),Te=E(require("cors"));var me=require("fast-content-type-parse"),le=require("radash");var ae=require("crypto");function pe(t,r){let e="",o=0,s=[],i=[],n=[],m={};for(let d=0;d<t.length;d++){let c=t[d]??NaN,p=d>0?t[d-1]??null:null,g=c===10&&p===13;if(c===10||c===13||(e+=String.fromCharCode(c)),o===0&&g)`--${r}`===e&&(o=1),e="";else if(o===1&&g)e.length?n.push(e):(m=Object.fromEntries(n.flatMap(f=>{let[a,u=""]=f.split(":");return a?.trim()?[[a.trim().toLowerCase(),u?.trim()]]:[]})),o=2,s=[]),e="";else if(o===2){if(e.length>r.length+4&&(e=""),`--${r}`===e){let f=s.length-e.length,a=s.slice(0,f-1);i.push(Ce({headers:m,part:a})),s=[],n=[],m={},e="",o=3}else s.push(c);g&&(e="")}else o===3&&g&&(o=1)}return i}function Ce(t){let r=ve(t.headers["content-disposition"]??"");return{headers:t.headers,name:r.name,data:Buffer.from(t.part),...r.filename&&{filename:r.filename,type:t.headers["content-type"]?.trim()}}}function ve(t){let r={type:null,name:null,filename:null},e=t.split(";").map(o=>o.trim());e[0]&&(r.type=e[0].toLowerCase());for(let o of e.slice(1)){let[s,i]=o.split("=").map(n=>n.trim());s&&i&&(r[s.toLowerCase()]=i.replace(/^"|"$/g,""))}return r}function X(t="----------------------"){return`--${t}${(0,ae.randomBytes)(12).toString("hex")}`}async function de(t,r=X()){let e=[];for(let[o,s]of Object.entries(t))for(let i of s)e.push(Buffer.from(`--${r}`)),typeof i=="string"?e.push(Buffer.from(`Content-Disposition: form-data; name="${o}"\r
\r
`),Buffer.from(i),Buffer.from(`\r
`)):i instanceof File&&e.push(Buffer.from(`Content-Disposition: form-data; name="${o}"; filename="${i.name}"\r
`),Buffer.from(`Content-Type: ${i.type||"application/octet-stream"}\r
\r
`),Buffer.from(await i.arrayBuffer()),Buffer.from(`\r
`));return e.push(Buffer.from(`--${r}--\r
`)),Buffer.concat(e)}function ce(t,r,e){let o=[],s=e.requestBody?.body.safeParse(t.body);s.error&&o.push({in:"body",result:s.error.errors});let i=e.parameters?.query?.safeParse(t.query);i?.error&&o.push({in:"queries",result:i.error.errors});let n=e.parameters?.path?.safeParse(t.params);n?.error&&o.push({in:"params",result:n.error.errors});let m=e.parameters?.header?.safeParse(t.headers);m?.error&&o.push({in:"headers",result:m.error.errors});let d=e.parameters?.cookie?.safeParse(t.cookies);return d?.error&&o.push({in:"cookies",result:d.error.errors}),o.length?(r.writeHead(400,{"content-type":"application/json"}).end(JSON.stringify(o)),null):{body:s?.data??null,queries:i?.data??{},params:n?.data??{},headers:m?.data??{},cookies:d?.data??{}}}function b(t,r,e,o){typeof o=="string"&&console.error(o?`[error:${o}]: ${e}`:`[error]: ${e}`),t.writeHead(r,{"content-type":"application/json"}).end(JSON.stringify({statusCode:r,message:e}))}function ue(t){let r=/:([^/]+)/g,e=$(t).replace(r,"{$1}"),o=[],s=null;for(;(s=r.exec(t))!==null;)o.push(s[1]);return{path:e,params:o}}function $(t){return t.replace(/\/+/gi,"/")}function ye(t,r,e){let o=[];t.on("data",s=>o.push(s)),t.on("end",async()=>{let s;try{s=(0,me.parse)(t.headers["content-type"]??"")}catch(i){b(r,400,String(i));return}if(o.length)if(s.type==="application/json"){let i=Buffer.concat(o);try{i.length&&Object.assign(t,{body:JSON.parse(i.toString("utf-8"))})}catch{return b(r,400,"Invalid JSON")}return e()}else if(s.type==="multipart/form-data"){let i=Buffer.concat(o),n=s.parameters.boundary?.trim().replace(/^["']|["']$/g,"");if(!n)return b(r,400,"Cannot find multipart boundary");let m=pe(i,n),d={};for(let p of m){if(!p.name)continue;let g=p.filename?new File([p.data],p.filename,p.type?{type:p.type}:{}):p.data.toString("utf-8");(d[p.name]??=[]).push(g)}let c=[];for(let[p,g=[]]of Object.entries(d))g.length>1&&c.push({field:p,message:"Duplicated key"});return c.length?b(r,400,JSON.stringify({in:"body",result:c.map(({field:p,message:g})=>({path:[p],message:g}))})):(Object.assign(t,{body:(0,le.mapValues)(d,p=>p[0])}),e())}else if(s.type==="application/x-www-form-urlencoded"){let i=Buffer.concat(o).toString("utf-8"),n=new URLSearchParams(i),m=[];return Array.from(n.keys()).reduce((d,c)=>(d.has(c)&&m.push(c),d.add(c)),new Set),m.length?b(r,400,JSON.stringify({in:"body",result:m.map(d=>({path:[d],message:"Duplicated key"}))})):(Object.assign(t,{body:Object.fromEntries(n)}),e())}else{if(s.type==="application/octet-stream")return Object.assign(t,{body:Buffer.concat(o)}),e();{let i=`'${s.type}' content type is not supported`;return b(r,415,i)}}else return e()}),t.on("error",s=>{b(r,500,String(s))})}function fe(t){return t.split(";").reduce((r,e)=>{let[o,...s]=e.trim().split("=");return o&&(r[o]=decodeURIComponent(s.join("="))),r},{})}function Ze(t,r,e){e?.cors&&t.use((0,Te.default)(typeof e.cors=="boolean"?{}:e.cors)),t.use(ye),console.log(`[server]: Registering ${Object.keys(r).length} endpoints...`);let o=new Set;for(let[s,i]of Object.entries(r)){let[n="",...m]=s.split(":"),d=m.join(":");if(o.has(i.operationId))throw new Error(`Duplicate operation ID "${i.operationId}" for path ${d}`);if(o.add(i.operationId),!ee.some(c=>c===n))throw new Error(`Invalid method "${n}" for path ${d}`);console.log(`[register]: ${i.operationId} -> ${n.toUpperCase()} ${d}`),t[n](d,async(c,p)=>{let g=Y.parse(c.url||"",!0);Object.assign(c,{query:g.query,cookies:fe(c.headers.cookie??"")});let _={};try{if(i.security?.length)for(let P of i.security)await P.authenticate(c,_);let f=ce(c,p,i),a=await i.handler(f,{extensions:_,req:c,res:p,...i.security&&{security:i.security}}),u=a instanceof w?a:new w({body:a}),O=u.payload.status??(n==="post"?201:200),T=i.responses[O]||i.responses.default;if(!T||typeof T=="boolean"||typeof T=="string")throw console.error(`[error]: There is no corresponding validator defined in schema for status ${O}/default`),new Error("Internal server error");try{T.body.parse(u.payload.body)}catch(P){throw console.error("[error]: Invalid output format to the corresponding defined output schema"),console.error(String(P)),new Error("Internal server error")}if(u.payload.body instanceof he.Readable||u.payload.body instanceof k.ReadStream)p.writeHead(O,u.payload.headers),u.payload.body.pipe(p);else if(typeof u.payload.body>"u")p.writeHead(O,u.payload.headers).end();else if(T instanceof x){let[P,q]=await T.serializeWithContentType(u.payload.body);p.writeHead(O,{"content-type":P,...u.payload.headers}).end(q)}else p.writeHead(O,{"content-type":T.mimeType,...u.payload.headers}).end(await T.serialize(u.payload.body))}catch(f){let a,u;f instanceof D?(a=f.status,u=f.message):f instanceof Error?(a=500,u=f.message,console.error(String(f))):(a=500,u=String(f),console.error(String(f))),p.writeHead(a,{"content-type":"application/json"}).end(JSON.stringify({statusCode:a,message:u}))}})}if(e?.docs){let s=JSON.stringify(e.docs.spec),i=k.readFileSync(ge.join(__dirname,`./templates/${e.docs.viewer}.hbs`),"utf-8").replace("{{title}}",e.docs.spec.info.title).replace("{{specUrl}}",e.docs.specPath).replace("{{theme}}",e.docs.theme??"");t.get(e.docs.specPath,(n,m)=>{m.writeHead(200,{"content-type":"application/json"}).end(s)}),t.get(e.docs.docsPath,(n,m)=>{m.writeHead(200,{"content-type":"text/html"}).end(i)})}t.use(async(s,i)=>{if(await e?.fallbackHandler?.(s,i),i.headersSent)return;let{pathname:n}=Y.parse(s.url||"",!0);b(i,404,`Cannot find ${s.method} ${n}`)})}var be=require("radash"),K=E(require("zod"));var ee=["get","post","put","patch","delete"];function Le(t){return{...t,...t.requestBody&&!(t.requestBody instanceof A)&&{requestBody:new R(t.requestBody)},responses:Object.fromEntries(Object.entries(t.responses).map(([r,e])=>[r,e instanceof K.default.ZodType?new R(e):e]))}}var w=class t{constructor(r){this.payload=r}static withoutBody(r,e){return e?new t({headers:e,status:r}):new t({status:r})}},te=class{constructor(r){this.name=r.name,this.schema=r.schema,this.handler=r.handler}apply(r){return new H(this,r)}},H=class{constructor(r,e){this.scopes=e,this.security=r}async authenticate(r,e){await this.security.handler(r,this.scopes,e)}},D=class extends Error{constructor(e,o){super(o);this.status=e;this.msg=o}},A=class{constructor(){this._description=null;this._headers=null;this._examples=null}describe(r){return this._description=r,this}get description(){return this._description}requireHeaders(r){return this._headers=r,this}get requiredHeaders(){return this._headers}setExamples(r){return this._examples=r,this}getExamples(){return this._examples}},M=class M extends A{constructor(e){super();this.body=e}async serialize(e){return Buffer.from(JSON.stringify(e))}get mimeType(){return M.mimeType}};M.mimeType="application/json";var R=M,N=class N extends A{constructor(e,o){super();this.body=e;this.encoding=o}async serialize(e){return(await this.serializeWithContentType(e))[1]}async serializeWithContentType(e){let o=X();return[`${N.mimeType}; boundary=${o}`,await de((0,be.mapValues)(e,s=>[s instanceof File?s:String(s)]),o)]}get mimeType(){return N.mimeType}};N.mimeType="multipart/form-data";var x=N,G=class G extends A{constructor(e,o){super();this.body=e;this.encoding=o}async serialize(e){return Buffer.from(new URLSearchParams(e instanceof URLSearchParams?e:Object.fromEntries(Object.entries(e).map(([o,s])=>[o,String(s)]))).toString())}get mimeType(){return G.mimeType}};G.mimeType="application/x-www-form-urlencoded";var C=G,J=class J extends A{constructor(e=K.default.instanceof(Buffer)){super();this.body=e}async serialize(e){return e}get mimeType(){return J.mimeType}};J.mimeType="application/octet-stream";var I=J,U=class U extends A{constructor(e=K.default.string()){super();this.body=e}async serialize(e){return Buffer.from(e)}get mimeType(){return U.mimeType}};U.mimeType="text/plain";var V=U,F=class F extends V{get mimeType(){return F.mimeType}};F.mimeType="text/html";var re=F;var v=E(require("http-status")),y=require("radash"),l=require("zod");var Oe=E(require("zod-to-json-schema")),Q="GeneralApiError",Re="ValidationError",$e=l.z.object({code:l.z.enum(["invalid_type","invalid_literal","unrecognized_keys","invalid_union","invalid_union_discriminator","invalid_enum_value","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite","custom"]),path:l.z.union([l.z.string(),l.z.number().int().min(0)]).array(),fatal:l.z.boolean().optional(),message:l.z.string()}).passthrough(),ke=l.z.object({in:l.z.enum(["body","queries","params","headers","cookies"]).describe("The part of a request where data validation failed"),result:l.z.array($e).describe("An array of error items")}),Pe=l.z.object({statusCode:l.z.number().int().min(100).max(599).describe("The HTTP response status code"),message:l.z.string().describe("The message associated with the error")}).describe("A general HTTP error response"),He=Pe.extend({message:l.z.union([l.z.array(ke).describe("An array of error schemas detailing validation issues"),l.z.string().describe("Alternatively, a simple error message")])}).describe("An error related to the validation process with more detailed information"),Ve=["https://spec.openapis.org/oas/3.1/dialect/base","https://spec.openapis.org/oas/3.1/dialect/2024-11-10"];function Me(t){let r={},e=new Set,o=new Set,s={};for(let[i,n]of Object.entries(t.paths)){let[m,...d]=i.split(":"),{path:c}=ue(d.join(":")),p=[],g=r[c]??{};for(let a of n.security??[])e.add(a.security);for(let a of n.tags??[])o.add(a);for(let[a,u]of Object.entries(n.parameters??{})){let{properties:O={},required:T=[]}=z(u);for(let[P,q]of Object.entries(O)){if("$ref"in q)continue;let{description:oe,...Ee}=q,se=T.includes(P);p.push({name:P,in:a,...oe&&{description:oe},...se&&{required:se},schema:Ee})}}let _=`${(0,y.pascal)((0,y.title)(n.operationId))}RequestBody`;n.requestBody&&n.requestBody.body._def.typeName!==l.z.ZodVoid.name&&!(n.requestBody instanceof I)&&(s[_]=z(n.requestBody.body,n.requestBody.mimeType));let f=`${(0,y.pascal)((0,y.title)(n.operationId))}Response`;for(let[,a]of Object.entries(n.responses??{}))a instanceof I||typeof a=="object"&&a.body._def.typeName!==l.z.ZodVoid.name&&(s[f]=z(a.body,a.mimeType));g[m]={...n.tags?.length&&{tags:Object.values(n.tags).map(a=>a.name)},summary:n.summary||n.operationId,...n.description&&{description:n.description},operationId:n.operationId,...n.deprecated&&{deprecated:n.deprecated},...!(0,y.isEmpty)(p)&&{parameters:p},...n.security?.length&&{security:n.security.map(a=>({[a.security.name]:a.scopes}))},...n.requestBody&&{requestBody:{...n.requestBody.description&&{description:n.requestBody.description},content:j(n.requestBody.mimeType,_,n.requestBody.body._def.typeName===l.z.ZodVoid.name||n.requestBody instanceof I,n.requestBody instanceof x||n.requestBody instanceof C?n.requestBody.encoding:void 0),required:!n.requestBody.body.isOptional()}},responses:{...(0,y.mapValues)((0,y.shake)(n.responses),(a,u)=>({description:(typeof a=="string"?a:null)||String(v.default[`${u}`])||"No description",content:typeof a=="boolean"||typeof a=="string"?j(R.mimeType,Q):j(a.mimeType,f,a.body._def.typeName===l.z.ZodVoid.name||a instanceof I)})),...(n.requestBody||!(0,y.isEmpty)(n.parameters))&&{400:{description:ne(n.responses,400)||v.default[400],content:j(R.mimeType,Re)}},...n.security?.length&&{401:{description:ne(n.responses,401)||v.default[401],content:j(R.mimeType,Q)}},500:{description:ne(n.responses,500)||v.default[500],content:j(R.mimeType,Q)}}},r[c]=g}return{openapi:t.openapi,info:t.info,jsonSchemaDialect:t.jsonSchemaDialect??Ve[0],paths:r,...t.webhooks&&{webhooks:t.webhooks},components:{schemas:{...s,[Q]:z(Pe),[Re]:z(He),...(0,y.mapEntries)(t.additionalSchemas??{},(i,n)=>[(0,y.pascal)((0,y.title)(i)),z(n)])},...e.size&&{securitySchemes:Object.fromEntries([...e.values()].map(i=>[i.name,i.schema]))}},tags:[...o.values()],...t.externalDocs&&{externalDocs:t.externalDocs}}}function j(t,r,e,o){return e?{[t]:{}}:{[t]:{schema:{$ref:`#/components/schemas/${r}`},...o&&{encoding:(0,y.mapValues)(o,s=>({...s,...s.contentType&&{contentType:s.contentType.join(", ")},...s.headers&&{headers:z(s.headers).properties}}))}}}}function ne(t,r){let e=t[r];return typeof e=="string"?e:null}function z(t,r){let e=(0,Oe.default)(t,{target:"jsonSchema2019-09",$refStrategy:"none"});if(r===x.mimeType)for(let o in e.properties??{})e.properties&&(0,y.isEmpty)(e.properties[o])&&(e.properties[o]={type:"string",contentMediaType:"application/octet-stream"});return delete e.$schema,e}var W=require("radash");function Ge(t,r){let e=[],o=[];for(let s of r){let i=Object.keys(s).map(n=>$(`${t}${n}`));o.push(...e.filter(n=>i.includes(n))),e.push(...i)}if(o.length)throw new Error(`Duplicated keys occured: ${o.join(", ")}`);return(0,W.mapKeys)(Object.assign({},...r),s=>$(s.replace(/:/,`:${t}`)))}function Je(t,r){return(0,W.mapValues)(t,e=>Object.assign(e,r))}0&&(module.exports={ApiError,AppliedSecurity,FormDataBody,HtmlBody,HttpResponse,JsonBody,METHODS,OctetStreamBody,Security,TextBody,UrlEncodedBody,applyGroupConfig,buildJson,createApi,endpoint,mergeEndpointGroups,oas3,...require("@routejs/router")});
//# sourceMappingURL=index.js.map