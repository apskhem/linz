"use strict";var Re=Object.create;var M=Object.defineProperty;var Se=Object.getOwnPropertyDescriptor;var Ee=Object.getOwnPropertyNames;var xe=Object.getPrototypeOf,Oe=Object.prototype.hasOwnProperty;var Be=(t,r)=>()=>(r||t((r={exports:{}}).exports,r),r.exports),Ie=(t,r)=>{for(var e in r)M(t,e,{get:r[e],enumerable:!0})},v=(t,r,e,o)=>{if(r&&typeof r=="object"||typeof r=="function")for(let s of Ee(r))!Oe.call(t,s)&&s!==e&&M(t,s,{get:()=>r[s],enumerable:!(o=Se(r,s))||o.enumerable});return t},x=(t,r,e)=>(v(t,r,"default"),e&&v(e,r,"default")),w=(t,r,e)=>(e=t!=null?Re(xe(t)):{},v(r||!t||!t.__esModule?M(e,"default",{value:t,enumerable:!0}):e,t)),Ae=t=>v(M({},"__esModule",{value:!0}),t);var ne=Be(O=>{"use strict";O.__esModule=!0;O.OpenAPIV2=O.OpenAPIV3=void 0;var ze;(function(t){var r;(function(e){e.GET="get",e.PUT="put",e.POST="post",e.DELETE="delete",e.OPTIONS="options",e.HEAD="head",e.PATCH="patch",e.TRACE="trace"})(r=t.HttpMethods||(t.HttpMethods={}))})(ze=O.OpenAPIV3||(O.OpenAPIV3={}));var we;(function(t){var r;(function(e){e.GET="get",e.PUT="put",e.POST="post",e.DELETE="delete",e.OPTIONS="options",e.HEAD="head",e.PATCH="patch"})(r=t.HttpMethods||(t.HttpMethods={}))})(we=O.OpenAPIV2||(O.OpenAPIV2={}))});var b={};Ie(b,{ApiError:()=>V,AppliedSecurity:()=>G,FormDataBody:()=>C,HtmlBody:()=>re,HttpResponse:()=>j,JsonBody:()=>R,METHODS:()=>ee,OctetStreamBody:()=>A,Security:()=>te,TextBody:()=>U,UrlEncodedBody:()=>k,applyGroupConfig:()=>Le,buildJson:()=>ke,createApi:()=>qe,endpoint:()=>Ne,mergeEndpointGroups:()=>Ze,oas3:()=>Pe.OpenAPIV3_1});module.exports=Ae(b);x(b,require("@routejs/router"),module.exports);var Pe=w(ne());var J=w(require("fs")),me=w(require("path")),ye=require("stream"),fe=w(require("cors")),he=require("radash"),ge=require("zod");var X=require("fast-content-type-parse"),Y=require("radash");var oe=require("crypto");function ae(t,r){let e="",o=0,s=[],a=[],n=[],p={};for(let c=0;c<t.length;c++){let u=t[c]??NaN,f=c>0?t[c-1]??null:null,d=u===10&&f===13;if(u===10||u===13||(e+=String.fromCharCode(u)),o===0&&d)`--${r}`===e&&(o=1),e="";else if(o===1&&d)e.length?n.push(e):(p=Object.fromEntries(n.flatMap(y=>{let[i,g=""]=y.split(":");return i?.trim()?[[i.trim().toLowerCase(),g?.trim()]]:[]})),o=2,s=[]),e="";else if(o===2){if(e.length>r.length+4&&(e=""),`--${r}`===e){let y=s.length-e.length,i=s.slice(0,y-1);a.push(je({headers:p,part:i})),s=[],n=[],p={},e="",o=3}else s.push(u);d&&(e="")}else o===3&&d&&(o=1)}return a}function je(t){let r=Ce(t.headers["content-disposition"]??"");return{headers:t.headers,name:r.name,data:Uint8Array.from(t.part),...r.filename&&{filename:r.filename,type:t.headers["content-type"]?.trim()}}}function Ce(t){let r={type:null,name:null,filename:null},e=t.split(";").map(o=>o.trim());e[0]&&(r.type=e[0].toLowerCase());for(let o of e.slice(1)){let[s,a]=o.split("=").map(n=>n.trim());s&&a&&(r[s.toLowerCase()]=a.replace(/^"|"$/g,""))}return r}function W(t="----------------------"){return`--${t}${(0,oe.randomBytes)(12).toString("hex")}`}async function ie(t,r=W()){let e=[];for(let[o,s]of Object.entries(t))for(let a of s)e.push(Buffer.from(`--${r}`)),typeof a=="string"?e.push(Buffer.from(`Content-Disposition: form-data; name="${o}"\r
\r
`),Buffer.from(a),Buffer.from(`\r
`)):a instanceof File&&e.push(Buffer.from(`Content-Disposition: form-data; name="${o}"; filename="${a.name}"\r
`),Buffer.from(`Content-Type: ${a.type||"application/octet-stream"}\r
\r
`),Buffer.from(await a.arrayBuffer()),Buffer.from(`\r
`));return e.push(Buffer.from(`--${r}--\r
`)),Buffer.concat(e)}var B=class extends Error{statusCode;constructor(r,e){super(e),this.statusCode=r}};function pe(t){return new Promise((r,e)=>{let o=[];t.on("data",s=>o.push(s)),t.on("end",()=>r(Buffer.concat(o))),t.on("error",s=>e(s))})}function de(t,r,e){if(!t.length)return;let o;try{o=(0,X.parse)(r??"")}catch(s){throw new B(400,String(s))}if(o.type==="application/json")try{let s=o.parameters.charset??"utf-8";return JSON.parse(t.toString(s))}catch(s){throw new B(400,String(s))}else if(o.type==="multipart/form-data"){let s=o.parameters.boundary?.trim().replace(/^["']|["']$/g,"");if(!s)throw new B(400,"Cannot find multipart boundary");let a=ae(t,s),n={};for(let p of a){let c=p.headers["content-type"],f=(c?(0,X.parse)(c):null)?.parameters.charset??"utf-8";if(!p.name)continue;let d=p.filename?new File([p.data],p.filename,p.type?{type:p.type}:{}):Buffer.from(p.data.buffer).toString(f);(n[p.name]??=[]).push(d)}return e?.multiValueFormData?n:(0,Y.mapValues)(n,p=>p.at(-1))}else if(o.type==="application/x-www-form-urlencoded"){let s=o?.parameters.charset??"utf-8",a=t.toString(s),n=new URLSearchParams(a),p={};for(let[c,u]of n.entries())(p[c]??=[]).push(u);return e?.multiValueUrlEncoded?p:(0,Y.mapValues)(p,c=>c.at(-1))}else{if(o.type==="application/octet-stream")return t;{let s=`'${o.type}' content type is not supported`;throw new B(415,s)}}}function ce(t){return t.split(";").reduce((r,e)=>{let[o,...s]=e.trim().split("=");return o&&(r[o]=decodeURIComponent(s.join("="))),r},{})}function _(t){try{return JSON.parse(String(t))}catch{return String(t)}}var H=class extends Error{errors=[];constructor(){super()}addIssue(r){this.errors.push(r)}hasIssue(){return this.errors.length>0}};function ue(t,r){let e=new H,o;try{o=r.requestBody?.body.safeParse(t.body),o?.error&&e.addIssue({in:"body",result:o.error.errors})}catch(c){e.addIssue({in:"body",result:_(c)})}let s;try{s=r.parameters?.query?.safeParse(t.queries),s?.error&&e.addIssue({in:"queries",result:s.error.errors})}catch(c){e.addIssue({in:"queries",result:_(c)})}let a;try{a=r.parameters?.path?.safeParse(t.params),a?.error&&e.addIssue({in:"params",result:a.error.errors})}catch(c){e.addIssue({in:"params",result:_(c)})}let n;try{n=r.parameters?.header?.safeParse(t.headers),n?.error&&e.addIssue({in:"headers",result:n.error.errors})}catch(c){e.addIssue({in:"headers",result:_(c)})}let p;try{p=r.parameters?.cookie?.safeParse(t.cookies),p?.error&&e.addIssue({in:"cookies",result:p.error.errors})}catch(c){e.addIssue({in:"cookies",result:_(c)})}if(e.hasIssue())throw e;return{body:o?.data,queries:s?.data??{},params:a?.data??{},headers:n?.data??{},cookies:p?.data??{}}}function le(t){let r=/:([^/]+)/g,e=$(t).replace(r,"{$1}"),o=[],s=null;for(;(s=r.exec(t))!==null;)o.push(s[1]);return{path:e,params:o}}function $(t){return t.replace(/\/+/gi,"/")}function qe(t,r,e){e?.cors&&t.use((0,fe.default)(typeof e.cors=="boolean"?{}:e.cors)),e?.logger?.info?.(`Registering ${Object.keys(r).length} endpoints...`);let o=new Set;for(let[s,a]of Object.entries(r)){let[n="",...p]=s.split(":"),c=p.join(":");if(o.has(a.operationId))throw new Error(`Duplicate operation ID "${a.operationId}" for path ${c}`);if(o.add(a.operationId),!ee.some(u=>u===n))throw new Error(`Invalid method "${n}" for path ${c}`);e?.logger?.info?.(`${a.operationId} -> ${n.toUpperCase()} ${c}`),t[n](c,async(u,f)=>{try{let d=await pe(u),h=de(d,u.headers["content-type"]??""),y={};if(a.security?.length)for(let P of a.security)await P.authenticate(u,y);let i=u.url?new URLSearchParams(u.url.split("?")[1]):[],g={};for(let[P,z]of i.entries())(g[P]??=[]).push(z);let Q=ue({body:h,queries:e?.request?.multiValueQueryString?g:(0,he.mapValues)(g,P=>P.at(-1)),cookies:ce(u.headers.cookie??""),params:u.params,headers:u.headers},a),N=await a.handler(Q,{extensions:y,req:u,res:f,...a.security&&{security:a.security}});if(f.headersSent)return;let T=N instanceof j?N:new j({body:N}),E=T.payload.status??(n==="post"?201:200),S=a.responses[E]||a.responses.default;if(!S||typeof S=="boolean"||typeof S=="string")throw e?.logger?.error?.(`There is no corresponding validator defined in schema for status ${E}/default`),new Error("Internal server error");if(T.payload.body instanceof ye.Readable||T.payload.body instanceof J.ReadStream)f.writeHead(E,T.payload.headers),T.payload.body.pipe(f);else{let P=S.body.parse(T.payload.body);if(typeof P>"u")f.writeHead(E,T.payload.headers).end();else{let z=await S.serialize(P);f.writeHead(E,{"content-type":S.mimeType,...z.headers,...T.payload.headers}).end(z.buffer)}}}catch(d){let h,y=[],i={};d instanceof V?(h=d.status,Array.isArray(d.errors)?y.push(...d.errors):y.push(d.errors),d.headers&&(i=d.headers)):d instanceof B?(h=d.statusCode,y.push({detail:d.message})):d instanceof H?(h=400,y.push(...d.errors.map(g=>({meta:g})))):d instanceof ge.z.ZodError?(h=500,y.push({detail:"Internal server error"}),e?.logger?.error?.("Invalid output format to the corresponding defined output schema"),e?.logger?.error?.(JSON.stringify(d))):d instanceof Error?(h=500,y.push({detail:d.message}),e?.logger?.error?.(String(d))):(h=500,y.push({detail:String(d)}),e?.logger?.error?.(String(d))),f.writeHead(h,{"content-type":"application/json",...i}).end(JSON.stringify({errors:y}))}})}if(e?.docs){let s=JSON.stringify(e.docs.spec),a=J.readFileSync(me.join(__dirname,`./templates/${e.docs.viewer}.hbs`),"utf-8").replace("{{title}}",e.docs.spec.info.title).replace("{{specUrl}}",e.docs.specPath).replace("{{theme}}",e.docs.theme??"");t.get(e.docs.specPath,(n,p)=>{p.writeHead(200,{"content-type":"application/json"}).end(s)}),t.get(e.docs.docsPath,(n,p)=>{p.writeHead(200,{"content-type":"text/html"}).end(a)})}t.use(async(s,a)=>{if(await e?.fallbackHandler?.(s,a),a.headersSent)return;let{pathname:n}=new URL(s.url||"",`http://${s.headers.host}`);a.writeHead(404,{"content-type":"application/json"}).end(JSON.stringify({errors:[{detail:`Cannot find ${s.method} ${n}`}]}))})}var Te=require("radash"),F=w(require("zod"));var ee=["get","post","put","patch","delete"];function Ne(t){return{...t,...t.requestBody&&!(t.requestBody instanceof I)&&{requestBody:new R(t.requestBody)},responses:Object.fromEntries(Object.entries(t.responses).map(([r,e])=>[r,e instanceof F.default.ZodType?new R(e):e]))}}var j=class t{constructor(r){this.payload=r}static withoutBody(r,e){return e?new t({headers:e,status:r}):new t({status:r})}},te=class{name;schema;handler;constructor(r){this.name=r.name,this.schema=r.schema,this.handler=r.handler}apply(r){return new G(this,r)}},G=class{scopes;security;constructor(r,e){this.scopes=e,this.security=r}async authenticate(r,e){await this.security.handler(r,this.scopes,e)}},V=class extends Error{constructor(e,o,s){super();this.status=e;this.errors=o;this.headers=s}},I=class{_description=null;_headers=null;_examples=null;describe(r){return this._description=r,this}get description(){return this._description}requireHeaders(r){return this._headers=r,this}get requiredHeaders(){return this._headers}setExamples(r){return this._examples=r,this}getExamples(){return this._examples}},R=class t extends I{constructor(e){super();this.body=e}static mimeType="application/json";async serialize(e){return{buffer:Buffer.from(JSON.stringify(e)),headers:{}}}get mimeType(){return t.mimeType}},C=class t extends I{constructor(e,o){super();this.body=e;this.encoding=o}static mimeType="multipart/form-data";async serialize(e){let o=W();return{buffer:await ie((0,Te.mapValues)(e,s=>[s instanceof File?s:String(s)]),o),headers:{"content-type":`${t.mimeType}; boundary=${o}`}}}get mimeType(){return t.mimeType}},k=class t extends I{constructor(e,o){super();this.body=e;this.encoding=o}static mimeType="application/x-www-form-urlencoded";async serialize(e){return{buffer:Buffer.from(new URLSearchParams(e instanceof URLSearchParams?e:Object.fromEntries(Object.entries(e).map(([o,s])=>[o,String(s)]))).toString()),headers:{}}}get mimeType(){return t.mimeType}},A=class t extends I{constructor(e=F.default.instanceof(Buffer)){super();this.body=e}static mimeType="application/octet-stream";async serialize(e){return{buffer:e,headers:{}}}get mimeType(){return t.mimeType}},U=class t extends I{constructor(e=F.default.string()){super();this.body=e}static mimeType="text/plain";async serialize(e){return{buffer:Buffer.from(e),headers:{}}}get mimeType(){return t.mimeType}},re=class t extends U{static mimeType="text/html";get mimeType(){return t.mimeType}};var L=w(require("http-status")),m=require("radash"),l=require("zod");var be=w(require("zod-to-json-schema")),_e=l.z.object({id:l.z.string().optional().describe("A unique identifier for this particular occurrence of the problem."),links:l.z.object({about:l.z.string().url().optional().describe("A link that leads to further details about this particular error.")}).optional().describe("Links that lead to further details about the error."),status:l.z.string().optional().describe("HTTP status code applicable to this error, represented as a string."),code:l.z.string().optional().describe("An application-specific error code identifying the type of error."),title:l.z.string().optional().describe("A short, human-readable summary of the problem that should not change from occurrence to occurrence."),detail:l.z.string().optional().describe("A human-readable explanation specific to this occurrence of the problem."),source:l.z.object({pointer:l.z.string().optional().describe("JSON Pointer to the request entity where the error originated (e.g., /data/attributes/email)."),parameter:l.z.string().optional().describe("Query parameter name that caused the error (e.g., 'sort')."),header:l.z.string().optional().describe("A string indicating the name of a single request header which caused the error.")}).optional().describe("An object containing references to the source of the error."),meta:l.z.record(l.z.any()).optional().describe("A meta object containing non-standard, implementation-specific details.")}).describe("A single error object conforming to JSON:API specification."),He=l.z.object({errors:l.z.array(_e).describe("Array of JSON:API error objects.")}).describe("JSON:API error response object."),Z="JsonApiError",Ve=["https://spec.openapis.org/oas/3.1/dialect/base","https://spec.openapis.org/oas/3.1/dialect/2024-11-10"];function ke(t){let r={},e=new Set,o=new Set,s={};for(let[a,n]of Object.entries(t.paths)){if(n.hidden)continue;let[p,...c]=a.split(":"),{path:u}=le(c.join(":")),f=[],d=r[u]??{};for(let i of n.security??[])e.add(i.security);for(let i of n.tags??[])o.add(i);for(let[i,g]of Object.entries(n.parameters??{})){let{properties:Q={},required:N=[]}=q(g);for(let[T,E]of Object.entries(Q)){if("$ref"in E)continue;let{description:S,...P}=E,z=N.includes(T);f.push({name:T,in:i,...S&&{description:S},...z&&{required:z},schema:P})}}let h=`${(0,m.pascal)((0,m.title)(n.operationId))}RequestBody`;n.requestBody&&n.requestBody.body._def.typeName!==l.z.ZodVoid.name&&!(n.requestBody instanceof A)&&(s[h]=q(n.requestBody.body,n.requestBody.mimeType));let y=`${(0,m.pascal)((0,m.title)(n.operationId))}Response`;for(let[,i]of Object.entries(n.responses??{}))i instanceof A||typeof i=="object"&&i.body._def.typeName!==l.z.ZodVoid.name&&(s[y]=q(i.body,i.mimeType));d[p]={...n.tags?.length&&{tags:Object.values(n.tags).map(i=>i.name)},summary:n.summary||n.operationId,...n.description&&{description:n.description},operationId:n.operationId,...n.deprecated&&{deprecated:n.deprecated},...!(0,m.isEmpty)(f)&&{parameters:f},...n.security?.length&&{security:n.security.map(i=>({[i.security.name]:i.scopes}))},...n.requestBody&&{requestBody:{...n.requestBody.description&&{description:n.requestBody.description},content:D(n.requestBody.mimeType,h,n.requestBody.body._def.typeName===l.z.ZodVoid.name||n.requestBody instanceof A,n.requestBody instanceof C||n.requestBody instanceof k?n.requestBody.encoding:void 0),required:!n.requestBody.body.isOptional()}},responses:{...(0,m.mapValues)((0,m.shake)(n.responses),(i,g)=>({description:(typeof i=="string"?i:null)||String(L.default[`${g}`])||"No description",content:typeof i=="boolean"||typeof i=="string"?D(R.mimeType,Z):D(i.mimeType,y,i.body._def.typeName===l.z.ZodVoid.name||i instanceof A)})),...(n.requestBody||!(0,m.isEmpty)(n.parameters))&&{400:{description:se(n.responses,400)||L.default[400],content:D(R.mimeType,Z)}},...n.security?.length&&{401:{description:se(n.responses,401)||L.default[401],content:D(R.mimeType,Z)}},500:{description:se(n.responses,500)||L.default[500],content:D(R.mimeType,Z)}}},r[u]=d}return{openapi:t.openapi,info:t.info,jsonSchemaDialect:t.jsonSchemaDialect??Ve[0],paths:r,...t.webhooks&&{webhooks:t.webhooks},components:{schemas:{...s,[Z]:q(He),...(0,m.mapEntries)(t.additionalSchemas??{},(a,n)=>[(0,m.pascal)((0,m.title)(a)),q(n)])},...e.size&&{securitySchemes:Object.fromEntries([...e.values()].map(a=>[a.name,a.schema]))}},tags:[...o.values()],...t.externalDocs&&{externalDocs:t.externalDocs}}}function D(t,r,e,o){return e?{[t]:{}}:{[t]:{schema:{$ref:`#/components/schemas/${r}`},...o&&{encoding:(0,m.mapValues)(o,s=>({...s,...s.contentType&&{contentType:s.contentType.join(", ")},...s.headers&&{headers:q(s.headers).properties}}))}}}}function se(t,r){let e=t[r];return typeof e=="string"?e:null}function q(t,r){let e=(0,be.default)(t,{target:"jsonSchema2019-09",$refStrategy:"none"});if(r===C.mimeType)for(let o in e.properties??{})e.properties&&(0,m.isEmpty)(e.properties[o])&&(e.properties[o]={type:"string",format:"binary",contentMediaType:"application/octet-stream"});return delete e.$schema,e}var K=require("radash");function Ze(t,r){let e=[],o=[];for(let s of r){let a=Object.keys(s).map(n=>$(`${t}${n}`));o.push(...e.filter(n=>a.includes(n))),e.push(...a)}if(o.length)throw new Error(`Duplicated keys occured: ${o.join(", ")}`);return(0,K.mapKeys)(Object.assign({},...r),s=>$(s.replace(/:/,`:${t}`)))}function Le(t,r){return(0,K.mapValues)(t,e=>(r.tags&&(e.tags?e.tags.push(...r.tags):e.tags=r.tags.slice()),r.security&&(e.security?e.security.push(...r.security):e.security=r.security.slice()),typeof r.hidden<"u"&&typeof e.hidden>"u"&&(e.hidden=r.hidden),typeof r.deprecated<"u"&&typeof e.deprecated>"u"&&(e.deprecated=r.deprecated),e))}0&&(module.exports={ApiError,AppliedSecurity,FormDataBody,HtmlBody,HttpResponse,JsonBody,METHODS,OctetStreamBody,Security,TextBody,UrlEncodedBody,applyGroupConfig,buildJson,createApi,endpoint,mergeEndpointGroups,oas3,...require("@routejs/router")});
//# sourceMappingURL=index.js.map