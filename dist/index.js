"use strict";var W=Object.create;var k=Object.defineProperty;var X=Object.getOwnPropertyDescriptor;var ee=Object.getOwnPropertyNames;var te=Object.getPrototypeOf,re=Object.prototype.hasOwnProperty;var ne=(e,t)=>{for(var r in t)k(e,r,{get:t[r],enumerable:!0})},L=(e,t,r,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of ee(t))!re.call(e,n)&&n!==r&&k(e,n,{get:()=>t[n],enumerable:!(s=X(t,n))||s.enumerable});return e};var N=(e,t,r)=>(r=e!=null?W(te(e)):{},L(t||!e||!e.__esModule?k(r,"default",{value:e,enumerable:!0}):r,e)),se=e=>L(k({},"__esModule",{value:!0}),e);var fe={};ne(fe,{ApiError:()=>Z,HttpResponse:()=>E,METHODS:()=>$,Security:()=>H,ValidationError:()=>g,applyGroupConfig:()=>me,buildJson:()=>ce,endpoint:()=>ye,initExpress:()=>oe,mergeEndpointGroups:()=>ue});module.exports=se(fe);var j=N(require("fs")),G=require("stream"),J=N(require("cors")),U=N(require("formidable")),_=require("lodash");var w=require("lodash");function M(e,t){let r={},s=z(()=>t.requestBody?.parse(e.body)||e.body,p=>r.body=JSON.parse(p.message)),n=z(()=>t.parameters?.query?.parse(e.query)||e.query,p=>r.queries=JSON.parse(p.message)),a=z(()=>t.parameters?.path?.parse(e.params)||e.params,p=>r.params=JSON.parse(p.message)),c=z(()=>t.parameters?.header?.parse(e.headers)||e.headers,p=>r.headers=JSON.parse(p.message)),P=z(()=>t.parameters?.cookie?.parse(e.cookies)||e.cookies,p=>r.cookies=JSON.parse(p.message));if(!(0,w.isEmpty)(r))throw new g(r);return{body:s??null,queries:n??{},params:a??{},headers:c??{},cookies:P??{}}}function x(e,t,r,s){typeof s=="string"&&console.error(s?`[error:${s}]: ${r}`:`[error]: ${r}`),e.status(t).contentType("application/json").send({statusCode:t,message:r})}function q(e){return typeof e=="string"||typeof e=="number"||typeof e=="boolean"?{contentType:"text/plain",body:String(e)}:Array.isArray(e)||typeof e=="object"?{contentType:"application/json",body:JSON.stringify(e)}:Buffer.isBuffer(e)?{contentType:"application/octet-stream",body:e}:e instanceof URLSearchParams?{contentType:"application/x-www-form-urlencoded",body:Array.from(e).map(t=>t.map(encodeURIComponent).join("=")).join("&")}:{contentType:"text/plain",body:String(e)}}function v(e){let t=/:([^/]+)/g,r=C(e).replace(t,"{$1}"),s=[],n=null;for(;(n=t.exec(e))!==null;)s.push(n[1]);return{path:r,params:(0,w.compact)(s)}}function C(e){return e.replace(/\/+/gi,"/")}function z(e,t){try{return e()}catch(r){return t(r),null}}function D(e,t,r){let s=[];e.on("data",n=>s.push(n)),e.on("end",()=>{let n=Buffer.concat(s);if(e.method==="GET")return r();if(e.headers["content-type"]==="application/json"){try{n.length&&(e.body=JSON.parse(n.toString("utf-8")))}catch{return x(t,400,"Invalid JSON")}return r()}else return x(t,415,`'${e.headers}' content type is not supported`)}),e.on("error",n=>{x(t,500,"Server Error")})}function oe(e,t,r){r?.cors&&e.use((0,J.default)(typeof r.cors=="boolean"?{}:r.cors)),e.use(D),console.log(`[server]: Registering ${Object.keys(t).length} endpoints...`);let s=new Set;for(let[n,a]of Object.entries(t)){let[c="",...P]=n.split(":"),p=P.join(":");if(s.has(a.operationId))throw new Error(`Duplicate operation ID "${a.operationId}" for path ${p}`);if(s.add(a.operationId),!$.some(y=>y===c))throw new Error(`Invalid method "${c}" for path ${p}`);console.log(`[register]: ${a.operationId} -> ${c.toUpperCase()} ${p}`),e[c](p,async(y,l)=>{let I={};if(y.headers["content-type"]?.startsWith("multipart/form-data")){let h=(0,U.default)({}),[o,f]=await h.parse(y),i={};for(let[d,O=[]]of Object.entries(o))i[d]??=[],i[d]?.push(...O);for(let[d,O=[]]of Object.entries(f)){i[d]??=[];let V=O.map(R=>{let K=j.readFileSync(R.filepath),Q=new Uint8Array(K),Y=new File([Q],R.originalFilename||R.newFilename,{type:R.mimetype||""});return j.rmSync(R.filepath),Y});i[d]?.push(...V)}let T=[];for(let[d,O=[]]of Object.entries(i))O.length>1&&T.push({field:d,message:"Duplicate keys"});if(T.length)return F(new g({body:T}),l);y.body=(0,_.mapValues)(i,d=>d[0])}try{let h=M(y,a);if(a.security?.length)for(let i of a.security)await i.inner.handler(h,I);let o=await a.handler(h,I),f=o instanceof E&&o.status?a.responses[o.status]||a.responses.default:a.responses[c==="post"?201:200]||a.responses.default;if(!f||typeof f=="boolean")throw console.error(`[error]: There is no corresponding validator defined in schema for status ${o?.status??"default"}`),new Error("Internal server error");try{f.parse(o instanceof E?o.body:o)}catch(i){throw console.error("[error]: Invalid output format to the corresponding defined output schema"),console.error(String(i)),new Error("Internal server error")}if(o instanceof E){if(o.body instanceof G.Readable){Object.entries(o.headers??{}).map(([T,d])=>l.setHeader(T,d)),o.body.pipe(l);return}let i=q(o.body);return l.header(o.headers).status(o.status??(c==="post"?201:200)).contentType(i.contentType).send(i.body)}else{let i=q(o);return l.status(c==="post"?201:200).contentType(i.contentType).send(i.body)}}catch(h){return F(h,l)}})}r?.docs&&ae(e,r.docs.path,r.docs.specUrl),ie(e)}function F(e,t){e instanceof Z?t.status(e.status).send({statusCode:e.status,message:e.message}):e instanceof g?t.status(400).send({statusCode:400,message:Object.entries(JSON.parse(e.message)).map(([r,s])=>({in:r,result:s}))}):e instanceof Error?(console.error(String(e)),t.status(500).send({statusCode:500,message:e.message})):(console.error(String(e)),t.status(500).send({statusCode:500,message:String(e)}))}function ae(e,t,r){e.get(t,(s,n)=>{n.contentType("html").send(j.readFileSync("dist/index.html"))}),e.get("/openapi.json",(s,n)=>{n.contentType("json").send(j.readFileSync(r))})}function ie(e){e.all("*",(t,r)=>{x(r,404,`Cannot find ${t.method.toUpperCase()} ${t.path}`)})}var B=require("@anatine/zod-openapi"),m=require("lodash"),u=require("zod");var A="ApiError",pe=u.z.object({statusCode:u.z.number().int().min(100).max(599),message:u.z.union([u.z.object({}),u.z.any().array(),u.z.string()])}),ke=u.z.object({statusCode:u.z.number().int().min(100).max(599),message:u.z.union([u.z.object({}),u.z.any().array(),u.z.string()])});function ce(e){let t={},r={};for(let[s,n]of Object.entries(e.paths)){let[a,...c]=s.split(/:/),{path:P,params:p}=v(c.join(":")),y=[],l=t[P]??{};if(n.parameters)for(let[o,f]of Object.entries(n.parameters)){let{properties:i={},required:T=[]}=(0,B.generateSchema)(f);for(let[d,O]of Object.entries(i)){let{description:V,...R}=O;y.push({name:d,in:o,description:V,required:T.includes(d)||void 0,schema:R})}}let I=`${(0,m.upperFirst)(n.operationId)}RequestBody`;if(n.requestBody){let o=(0,B.generateSchema)(n.requestBody);r[I]=n.requestBodyType==="multipart/form-data"?de(o):o}let h=`${(0,m.upperFirst)(n.operationId)}Response`;if(n.responses)for(let[o,f]of Object.entries(n.responses))typeof f=="object"&&(r[h]=(0,B.generateSchema)(f));l[a]={tags:n.tags?.length?Object.values(n.tags).map(o=>o.name):void 0,summary:n.summary||n.operationId,description:n.description,operationId:n.operationId,deprecated:n.deprecated,parameters:(0,m.isEmpty)(y)?void 0:y,security:n.security?.map(o=>({[o.inner.name]:[]})),requestBody:n.requestBody?{description:"[DUMMY]",content:S(n.requestBodyType||"application/json",I)}:void 0,responses:{...(0,m.mapValues)(n.responses,o=>({description:"[DUMMY]",content:typeof o=="boolean"?S("application/json",A):S("application/json",h)})),400:n.requestBody||!(0,m.isEmpty)(n.parameters)?{description:"Misformed data in a sending request",content:S("application/json",A)}:void 0,401:n.security?.length?{description:"Unauthorized",content:S("application/json",A)}:void 0,500:{description:"Server unhandled or runtime error that may occur",content:S("application/json",A)}}},t[P]=l}return{openapi:e.openapi,info:e.info,paths:t,components:{schemas:{...r,[A]:(0,B.generateSchema)(pe)},securitySchemes:e.security?.length?(0,m.mapValues)((0,m.keyBy)(e.security.map(s=>s.inner),"name"),({handler:s,name:n,...a})=>a):void 0},tags:e.tags&&!(0,m.isEmpty)(e.tags)?Object.values(e.tags):void 0}}function S(e,t){return{[e]:{schema:{$ref:`#/components/schemas/${t}`}}}}function de(e){return{type:e.type,properties:(0,m.mapValues)(e.properties,t=>t.nullable?{type:"string",format:"binary"}:t)}}var b=require("lodash");function ue(e,t){let r=[];for(let s of t){let n=Object.keys(s).map(c=>C(`${e}${c}`)),a=(0,b.intersection)(r,n);if(a.length)throw new Error(`Duplication keys occured: ${a.join(", ")}`);r.push(...n)}return(0,b.mapKeys)((0,b.merge)({},...t),(s,n)=>C(n.replace(/:/,`:${e}`)))}function me(e,t){return(0,b.mapValues)(e,r=>({...t,...r}))}var $=["get","post","put","patch","delete"];function ye(e){return e}var E=class{constructor(t){this.headers=t.headers,this.status=t.status,this.body=t.body}},H=class{constructor(t){this.inner=t}use(t,r){return this}},Z=class extends Error{constructor(r,s){super(s);this.status=r;this.msg=s}},g=class extends Error{constructor(r){super(JSON.stringify(r));this.msg=r}};0&&(module.exports={ApiError,HttpResponse,METHODS,Security,ValidationError,applyGroupConfig,buildJson,endpoint,initExpress,mergeEndpointGroups});
//# sourceMappingURL=index.js.map