var ge=Object.create;var Y=Object.defineProperty;var Te=Object.getOwnPropertyDescriptor;var be=Object.getOwnPropertyNames;var Re=Object.getPrototypeOf,Pe=Object.prototype.hasOwnProperty;var Se=(t,r)=>()=>(r||t((r={exports:{}}).exports,r),r.exports);var Ee=(t,r,e,s)=>{if(r&&typeof r=="object"||typeof r=="function")for(let o of be(r))!Pe.call(t,o)&&o!==e&&Y(t,o,{get:()=>r[o],enumerable:!(s=Te(r,o))||s.enumerable});return t};var Oe=(t,r,e)=>(e=t!=null?ge(Re(t)):{},Ee(r||!t||!t.__esModule?Y(e,"default",{value:t,enumerable:!0}):e,t));var ee=Se(P=>{"use strict";P.__esModule=!0;P.OpenAPIV2=P.OpenAPIV3=void 0;var xe;(function(t){var r;(function(e){e.GET="get",e.PUT="put",e.POST="post",e.DELETE="delete",e.OPTIONS="options",e.HEAD="head",e.PATCH="patch",e.TRACE="trace"})(r=t.HttpMethods||(t.HttpMethods={}))})(xe=P.OpenAPIV3||(P.OpenAPIV3={}));var Be;(function(t){var r;(function(e){e.GET="get",e.PUT="put",e.POST="post",e.DELETE="delete",e.OPTIONS="options",e.HEAD="head",e.PATCH="patch"})(r=t.HttpMethods||(t.HttpMethods={}))})(Be=P.OpenAPIV2||(P.OpenAPIV2={}))});var ke=Oe(ee());export*from"@routejs/router";import*as j from"fs";import*as de from"path";import{Readable as je}from"stream";import*as M from"url";import Ne from"cors";import{parse as we}from"fast-content-type-parse";import{randomBytes as Ie}from"crypto";function te(t,r){let e="",s=0,o=[],i=[],n=[],c={};for(let l=0;l<t.length;l++){let u=t[l]??NaN,y=l>0?t[l-1]??null:null,p=u===10&&y===13;if(u===10||u===13||(e+=String.fromCharCode(u)),s===0&&p)`--${r}`===e&&(s=1),e="";else if(s===1&&p)e.length?n.push(e):(c=Object.fromEntries(n.flatMap(m=>{let[a,g=""]=m.split(":");return a?.trim()?[[a.trim().toLowerCase(),g?.trim()]]:[]})),s=2,o=[]),e="";else if(s===2){if(e.length>r.length+4&&(e=""),`--${r}`===e){let m=o.length-e.length,a=o.slice(0,m-1);i.push(Ae({headers:c,part:a})),o=[],n=[],c={},e="",s=3}else o.push(u);p&&(e="")}else s===3&&p&&(s=1)}return i}function Ae(t){let r=ze(t.headers["content-disposition"]??"");return{headers:t.headers,name:r.name,data:Buffer.from(t.part),...r.filename&&{filename:r.filename,type:t.headers["content-type"]?.trim()}}}function ze(t){let r={type:null,name:null,filename:null},e=t.split(";").map(s=>s.trim());e[0]&&(r.type=e[0].toLowerCase());for(let s of e.slice(1)){let[o,i]=s.split("=").map(n=>n.trim());o&&i&&(r[o.toLowerCase()]=i.replace(/^"|"$/g,""))}return r}function $(t="----------------------"){return`--${t}${Ie(12).toString("hex")}`}async function re(t,r=$()){let e=[];for(let[s,o]of Object.entries(t))for(let i of o)e.push(Buffer.from(`--${r}`)),typeof i=="string"?e.push(Buffer.from(`Content-Disposition: form-data; name="${s}"\r
\r
`),Buffer.from(i),Buffer.from(`\r
`)):i instanceof File&&e.push(Buffer.from(`Content-Disposition: form-data; name="${s}"; filename="${i.name}"\r
`),Buffer.from(`Content-Type: ${i.type||"application/octet-stream"}\r
\r
`),Buffer.from(await i.arrayBuffer()),Buffer.from(`\r
`));return e.push(Buffer.from(`--${r}--\r
`)),Buffer.concat(e)}var S=class extends Error{constructor(r,e){super(e),this.statusCode=r}};function ne(t){return new Promise((r,e)=>{let s=[];t.on("data",o=>s.push(o)),t.on("end",()=>r(Buffer.concat(s))),t.on("error",o=>e(o))})}function se(t,r){let e;try{e=we(r??"")}catch(s){throw new S(400,String(s))}if(t.length)if(e.type==="application/json")try{JSON.parse(t.toString(e.parameters.charset??"utf-8"))}catch{throw new S(400,"Invalid JSON")}else if(e.type==="multipart/form-data"){let s=e.parameters.boundary?.trim().replace(/^["']|["']$/g,"");if(!s)throw new S(400,"Cannot find multipart boundary");let o=te(t,s),i={};for(let n of o){if(!n.name)continue;let c=n.filename?new File([n.data],n.filename,n.type?{type:n.type}:{}):n.data.toString("utf-8");(i[n.name]??=[]).push(c)}return i}else if(e.type==="application/x-www-form-urlencoded"){let s=t.toString(e.parameters.charset??"utf-8"),o=new URLSearchParams(s),i={};for(let[n,c]of o.entries())(i[n]??=[]).push(c);return i}else{if(e.type==="application/octet-stream")return t;{let s=`'${e.type}' content type is not supported`;throw new S(415,s)}}else return null}function oe(t){return t.split(";").reduce((r,e)=>{let[s,...o]=e.trim().split("=");return s&&(r[s]=decodeURIComponent(o.join("="))),r},{})}function ie(t,r,e){let s=[],o=e.requestBody?.body.safeParse(t.body);o.error&&s.push({in:"body",result:o.error.errors});let i=e.parameters?.query?.safeParse(t.query);i?.error&&s.push({in:"queries",result:i.error.errors});let n=e.parameters?.path?.safeParse(t.params);n?.error&&s.push({in:"params",result:n.error.errors});let c=e.parameters?.header?.safeParse(t.headers);c?.error&&s.push({in:"headers",result:c.error.errors});let l=e.parameters?.cookie?.safeParse(t.cookies);return l?.error&&s.push({in:"cookies",result:l.error.errors}),s.length?(r.writeHead(400,{"content-type":"application/json"}).end(JSON.stringify(s)),null):{body:o?.data??null,queries:i?.data??{},params:n?.data??{},headers:c?.data??{},cookies:l?.data??{}}}function ae(t,r,e,s){typeof s=="string"&&console.error(s?`[error:${s}]: ${e}`:`[error]: ${e}`),t.writeHead(r,{"content-type":"application/json"}).end(JSON.stringify({statusCode:r,message:e}))}function pe(t){let r=/:([^/]+)/g,e=w(t).replace(r,"{$1}"),s=[],o=null;for(;(o=r.exec(t))!==null;)s.push(o[1]);return{path:e,params:s}}function w(t){return t.replace(/\/+/gi,"/")}function rt(t,r,e){e?.cors&&t.use(Ne(typeof e.cors=="boolean"?{}:e.cors)),console.log(`[server]: Registering ${Object.keys(r).length} endpoints...`);let s=new Set;for(let[o,i]of Object.entries(r)){let[n="",...c]=o.split(":"),l=c.join(":");if(s.has(i.operationId))throw new Error(`Duplicate operation ID "${i.operationId}" for path ${l}`);if(s.add(i.operationId),!ce.some(u=>u===n))throw new Error(`Invalid method "${n}" for path ${l}`);console.log(`[register]: ${i.operationId} -> ${n.toUpperCase()} ${l}`),t[n](l,async(u,y)=>{try{let p=await ne(u),f=se(p,u.headers["content-type"]??""),m={};if(i.security?.length)for(let b of i.security)await b.authenticate(u,m);let a=ie({body:f,query:M.parse(u.url||"",!0).query,cookies:oe(u.headers.cookie??""),params:u.params,headers:u.headers},y,i),g=await i.handler(a,{extensions:m,req:u,res:y,...i.security&&{security:i.security}}),h=g instanceof A?g:new A({body:g}),O=h.payload.status??(n==="post"?201:200),T=i.responses[O]||i.responses.default;if(!T||typeof T=="boolean"||typeof T=="string")throw console.error(`[error]: There is no corresponding validator defined in schema for status ${O}/default`),new Error("Internal server error");try{T.body.parse(h.payload.body)}catch(b){throw console.error("[error]: Invalid output format to the corresponding defined output schema"),console.error(String(b)),new Error("Internal server error")}if(h.payload.body instanceof je||h.payload.body instanceof j.ReadStream)y.writeHead(O,h.payload.headers),h.payload.body.pipe(y);else if(typeof h.payload.body>"u")y.writeHead(O,h.payload.headers).end();else{let b=await T.serialize(h.payload.body);y.writeHead(O,{"content-type":T.mimeType,...b.headers,...h.payload.headers}).end(b.buffer)}}catch(p){let f,m;p instanceof N?(f=p.status,m=p.message):p instanceof S?(f=p.statusCode,m=p.message):p instanceof Error?(f=500,m=p.message,console.error(String(p))):(f=500,m=String(p),console.error(String(p))),y.writeHead(f,{"content-type":"application/json"}).end(JSON.stringify({statusCode:f,message:m}))}})}if(e?.docs){let o=JSON.stringify(e.docs.spec),i=j.readFileSync(de.join(__dirname,`./templates/${e.docs.viewer}.hbs`),"utf-8").replace("{{title}}",e.docs.spec.info.title).replace("{{specUrl}}",e.docs.specPath).replace("{{theme}}",e.docs.theme??"");t.get(e.docs.specPath,(n,c)=>{c.writeHead(200,{"content-type":"application/json"}).end(o)}),t.get(e.docs.docsPath,(n,c)=>{c.writeHead(200,{"content-type":"text/html"}).end(i)})}t.use(async(o,i)=>{if(await e?.fallbackHandler?.(o,i),i.headersSent)return;let{pathname:n}=M.parse(o.url||"",!0);ae(i,404,`Cannot find ${o.method} ${n}`)})}import{mapValues as Ce}from"radash";import J from"zod";var ce=["get","post","put","patch","delete"];function at(t){return{...t,...t.requestBody&&!(t.requestBody instanceof E)&&{requestBody:new R(t.requestBody)},responses:Object.fromEntries(Object.entries(t.responses).map(([r,e])=>[r,e instanceof J.ZodType?new R(e):e]))}}var A=class t{constructor(r){this.payload=r}static withoutBody(r,e){return e?new t({headers:e,status:r}):new t({status:r})}},ue=class{constructor(r){this.name=r.name,this.schema=r.schema,this.handler=r.handler}apply(r){return new k(this,r)}},k=class{constructor(r,e){this.scopes=e,this.security=r}async authenticate(r,e){await this.security.handler(r,this.scopes,e)}},N=class extends Error{constructor(e,s){super(s);this.status=e;this.msg=s}},E=class{constructor(){this._description=null;this._headers=null;this._examples=null}describe(r){return this._description=r,this}get description(){return this._description}requireHeaders(r){return this._headers=r,this}get requiredHeaders(){return this._headers}setExamples(r){return this._examples=r,this}getExamples(){return this._examples}},D=class D extends E{constructor(e){super();this.body=e}async serialize(e){return{buffer:Buffer.from(JSON.stringify(e)),headers:{}}}get mimeType(){return D.mimeType}};D.mimeType="application/json";var R=D,z=class z extends E{constructor(e,s){super();this.body=e;this.encoding=s}async serialize(e){let s=$();return{buffer:await re(Ce(e,o=>[o instanceof File?o:String(o)]),s),headers:{"content-type":`${z.mimeType}; boundary=${s}`}}}get mimeType(){return z.mimeType}};z.mimeType="multipart/form-data";var _=z,q=class q extends E{constructor(e,s){super();this.body=e;this.encoding=s}async serialize(e){return{buffer:Buffer.from(new URLSearchParams(e instanceof URLSearchParams?e:Object.fromEntries(Object.entries(e).map(([s,o])=>[s,String(o)]))).toString()),headers:{}}}get mimeType(){return q.mimeType}};q.mimeType="application/x-www-form-urlencoded";var C=q,v=class v extends E{constructor(e=J.instanceof(Buffer)){super();this.body=e}async serialize(e){return{buffer:e,headers:{}}}get mimeType(){return v.mimeType}};v.mimeType="application/octet-stream";var x=v,Z=class Z extends E{constructor(e=J.string()){super();this.body=e}async serialize(e){return{buffer:Buffer.from(e),headers:{}}}get mimeType(){return Z.mimeType}};Z.mimeType="text/plain";var G=Z,H=class H extends G{get mimeType(){return H.mimeType}};H.mimeType="text/html";var le=H;import L from"http-status";import{isEmpty as Q,mapEntries as De,mapValues as ye,pascal as U,shake as qe,title as F}from"radash";import{z as d}from"zod";import ve from"zod-to-json-schema";var V="GeneralApiError",me="ValidationError",Ze=d.object({code:d.enum(["invalid_type","invalid_literal","unrecognized_keys","invalid_union","invalid_union_discriminator","invalid_enum_value","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite","custom"]),path:d.union([d.string(),d.number().int().min(0)]).array(),fatal:d.boolean().optional(),message:d.string()}).passthrough(),He=d.object({in:d.enum(["body","queries","params","headers","cookies"]).describe("The part of a request where data validation failed"),result:d.array(Ze).describe("An array of error items")}),fe=d.object({statusCode:d.number().int().min(100).max(599).describe("The HTTP response status code"),message:d.string().describe("The message associated with the error")}).describe("A general HTTP error response"),Le=fe.extend({message:d.union([d.array(He).describe("An array of error schemas detailing validation issues"),d.string().describe("Alternatively, a simple error message")])}).describe("An error related to the validation process with more detailed information"),Ve=["https://spec.openapis.org/oas/3.1/dialect/base","https://spec.openapis.org/oas/3.1/dialect/2024-11-10"];function Tt(t){let r={},e=new Set,s=new Set,o={};for(let[i,n]of Object.entries(t.paths)){let[c,...l]=i.split(":"),{path:u}=pe(l.join(":")),y=[],p=r[u]??{};for(let a of n.security??[])e.add(a.security);for(let a of n.tags??[])s.add(a);for(let[a,g]of Object.entries(n.parameters??{})){let{properties:h={},required:O=[]}=B(g);for(let[T,b]of Object.entries(h)){if("$ref"in b)continue;let{description:W,...he}=b,X=O.includes(T);y.push({name:T,in:a,...W&&{description:W},...X&&{required:X},schema:he})}}let f=`${U(F(n.operationId))}RequestBody`;n.requestBody&&n.requestBody.body._def.typeName!==d.ZodVoid.name&&!(n.requestBody instanceof x)&&(o[f]=B(n.requestBody.body,n.requestBody.mimeType));let m=`${U(F(n.operationId))}Response`;for(let[,a]of Object.entries(n.responses??{}))a instanceof x||typeof a=="object"&&a.body._def.typeName!==d.ZodVoid.name&&(o[m]=B(a.body,a.mimeType));p[c]={...n.tags?.length&&{tags:Object.values(n.tags).map(a=>a.name)},summary:n.summary||n.operationId,...n.description&&{description:n.description},operationId:n.operationId,...n.deprecated&&{deprecated:n.deprecated},...!Q(y)&&{parameters:y},...n.security?.length&&{security:n.security.map(a=>({[a.security.name]:a.scopes}))},...n.requestBody&&{requestBody:{...n.requestBody.description&&{description:n.requestBody.description},content:I(n.requestBody.mimeType,f,n.requestBody.body._def.typeName===d.ZodVoid.name||n.requestBody instanceof x,n.requestBody instanceof _||n.requestBody instanceof C?n.requestBody.encoding:void 0),required:!n.requestBody.body.isOptional()}},responses:{...ye(qe(n.responses),(a,g)=>({description:(typeof a=="string"?a:null)||String(L[`${g}`])||"No description",content:typeof a=="boolean"||typeof a=="string"?I(R.mimeType,V):I(a.mimeType,m,a.body._def.typeName===d.ZodVoid.name||a instanceof x)})),...(n.requestBody||!Q(n.parameters))&&{400:{description:K(n.responses,400)||L[400],content:I(R.mimeType,me)}},...n.security?.length&&{401:{description:K(n.responses,401)||L[401],content:I(R.mimeType,V)}},500:{description:K(n.responses,500)||L[500],content:I(R.mimeType,V)}}},r[u]=p}return{openapi:t.openapi,info:t.info,jsonSchemaDialect:t.jsonSchemaDialect??Ve[0],paths:r,...t.webhooks&&{webhooks:t.webhooks},components:{schemas:{...o,[V]:B(fe),[me]:B(Le),...De(t.additionalSchemas??{},(i,n)=>[U(F(i)),B(n)])},...e.size&&{securitySchemes:Object.fromEntries([...e.values()].map(i=>[i.name,i.schema]))}},tags:[...s.values()],...t.externalDocs&&{externalDocs:t.externalDocs}}}function I(t,r,e,s){return e?{[t]:{}}:{[t]:{schema:{$ref:`#/components/schemas/${r}`},...s&&{encoding:ye(s,o=>({...o,...o.contentType&&{contentType:o.contentType.join(", ")},...o.headers&&{headers:B(o.headers).properties}}))}}}}function K(t,r){let e=t[r];return typeof e=="string"?e:null}function B(t,r){let e=ve(t,{target:"jsonSchema2019-09",$refStrategy:"none"});if(r===_.mimeType)for(let s in e.properties??{})e.properties&&Q(e.properties[s])&&(e.properties[s]={type:"string",contentMediaType:"application/octet-stream"});return delete e.$schema,e}import{mapKeys as $e,mapValues as Me}from"radash";function St(t,r){let e=[],s=[];for(let o of r){let i=Object.keys(o).map(n=>w(`${t}${n}`));s.push(...e.filter(n=>i.includes(n))),e.push(...i)}if(s.length)throw new Error(`Duplicated keys occured: ${s.join(", ")}`);return $e(Object.assign({},...r),o=>w(o.replace(/:/,`:${t}`)))}function Et(t,r){return Me(t,e=>Object.assign(e,r))}var export_oas3=ke.OpenAPIV3_1;export{N as ApiError,k as AppliedSecurity,_ as FormDataBody,le as HtmlBody,A as HttpResponse,R as JsonBody,ce as METHODS,x as OctetStreamBody,ue as Security,G as TextBody,C as UrlEncodedBody,Et as applyGroupConfig,Tt as buildJson,rt as createApi,at as endpoint,St as mergeEndpointGroups,export_oas3 as oas3};
//# sourceMappingURL=index.mjs.map