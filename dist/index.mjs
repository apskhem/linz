var Re=Object.create;var ee=Object.defineProperty;var Pe=Object.getOwnPropertyDescriptor;var Ee=Object.getOwnPropertyNames;var Se=Object.getPrototypeOf,xe=Object.prototype.hasOwnProperty;var Be=(t,r)=>()=>(r||t((r={exports:{}}).exports,r),r.exports);var Oe=(t,r,e,s)=>{if(r&&typeof r=="object"||typeof r=="function")for(let o of Ee(r))!xe.call(t,o)&&o!==e&&ee(t,o,{get:()=>r[o],enumerable:!(s=Pe(r,o))||s.enumerable});return t};var Ie=(t,r,e)=>(e=t!=null?Re(Se(t)):{},Oe(r||!t||!t.__esModule?ee(e,"default",{value:t,enumerable:!0}):e,t));var te=Be(E=>{"use strict";E.__esModule=!0;E.OpenAPIV2=E.OpenAPIV3=void 0;var Ae;(function(t){var r;(function(e){e.GET="get",e.PUT="put",e.POST="post",e.DELETE="delete",e.OPTIONS="options",e.HEAD="head",e.PATCH="patch",e.TRACE="trace"})(r=t.HttpMethods||(t.HttpMethods={}))})(Ae=E.OpenAPIV3||(E.OpenAPIV3={}));var ze;(function(t){var r;(function(e){e.GET="get",e.PUT="put",e.POST="post",e.DELETE="delete",e.OPTIONS="options",e.HEAD="head",e.PATCH="patch"})(r=t.HttpMethods||(t.HttpMethods={}))})(ze=E.OpenAPIV2||(E.OpenAPIV2={}))});var Fe=Ie(te());export*from"@routejs/router";import*as j from"fs";import*as le from"path";import{Readable as je}from"stream";import*as G from"url";import Ne from"cors";import{mapValues as qe}from"radash";import{parse as se}from"fast-content-type-parse";import{mapValues as oe}from"radash";import{randomBytes as _e}from"crypto";function re(t,r){let e="",s=0,o=[],a=[],n=[],i={};for(let l=0;l<t.length;l++){let c=t[l]??NaN,y=l>0?t[l-1]??null:null,d=c===10&&y===13;if(c===10||c===13||(e+=String.fromCharCode(c)),s===0&&d)`--${r}`===e&&(s=1),e="";else if(s===1&&d)e.length?n.push(e):(i=Object.fromEntries(n.flatMap(m=>{let[p,b=""]=m.split(":");return p?.trim()?[[p.trim().toLowerCase(),b?.trim()]]:[]})),s=2,o=[]),e="";else if(s===2){if(e.length>r.length+4&&(e=""),`--${r}`===e){let m=o.length-e.length,p=o.slice(0,m-1);a.push(we({headers:i,part:p})),o=[],n=[],i={},e="",s=3}else o.push(c);d&&(e="")}else s===3&&d&&(s=1)}return a}function we(t){let r=Ce(t.headers["content-disposition"]??"");return{headers:t.headers,name:r.name,data:Buffer.from(t.part),...r.filename&&{filename:r.filename,type:t.headers["content-type"]?.trim()}}}function Ce(t){let r={type:null,name:null,filename:null},e=t.split(";").map(s=>s.trim());e[0]&&(r.type=e[0].toLowerCase());for(let s of e.slice(1)){let[o,a]=s.split("=").map(n=>n.trim());o&&a&&(r[o.toLowerCase()]=a.replace(/^"|"$/g,""))}return r}function k(t="----------------------"){return`--${t}${_e(12).toString("hex")}`}async function ne(t,r=k()){let e=[];for(let[s,o]of Object.entries(t))for(let a of o)e.push(Buffer.from(`--${r}`)),typeof a=="string"?e.push(Buffer.from(`Content-Disposition: form-data; name="${s}"\r
\r
`),Buffer.from(a),Buffer.from(`\r
`)):a instanceof File&&e.push(Buffer.from(`Content-Disposition: form-data; name="${s}"; filename="${a.name}"\r
`),Buffer.from(`Content-Type: ${a.type||"application/octet-stream"}\r
\r
`),Buffer.from(await a.arrayBuffer()),Buffer.from(`\r
`));return e.push(Buffer.from(`--${r}--\r
`)),Buffer.concat(e)}var S=class extends Error{constructor(r,e){super(e),this.statusCode=r}};function ae(t){return new Promise((r,e)=>{let s=[];t.on("data",o=>s.push(o)),t.on("end",()=>r(Buffer.concat(s))),t.on("error",o=>e(o))})}function ie(t,r,e){if(!t.length)return;let s;try{s=se(r??"")}catch(o){throw new S(400,String(o))}if(s.type==="application/json")try{let o=s.parameters.charset??"utf-8";return JSON.parse(t.toString(o))}catch(o){throw new S(400,String(o))}else if(s.type==="multipart/form-data"){let o=s.parameters.boundary?.trim().replace(/^["']|["']$/g,"");if(!o)throw new S(400,"Cannot find multipart boundary");let a=re(t,o),n={};for(let i of a){let l=i.headers["content-type"],y=(l?se(l):null)?.parameters.charset??"utf-8";if(!i.name)continue;let d=i.filename?new File([i.data],i.filename,i.type?{type:i.type}:{}):i.data.toString(y);(n[i.name]??=[]).push(d)}return e?.multiValueFormData?n:oe(n,i=>i.at(-1))}else if(s.type==="application/x-www-form-urlencoded"){let o=s?.parameters.charset??"utf-8",a=t.toString(o),n=new URLSearchParams(a),i={};for(let[l,c]of n.entries())(i[l]??=[]).push(c);return e?.multiValueUrlEncoded?i:oe(i,l=>l.at(-1))}else{if(s.type==="application/octet-stream")return t;{let o=`'${s.type}' content type is not supported`;throw new S(415,o)}}}function pe(t){return t.split(";").reduce((r,e)=>{let[s,...o]=e.trim().split("=");return s&&(r[s]=decodeURIComponent(o.join("="))),r},{})}var z=class extends Error{constructor(){super();this.errors=[]}addIssue(e){this.errors.push(e)}hasIssue(){return this.errors.length>0}};function de(t,r){let e=new z,s=r.requestBody?.body.safeParse(t.body);s?.error&&e.addIssue({in:"body",result:s.error.errors});let o=r.parameters?.query?.safeParse(t.queries);o?.error&&e.addIssue({in:"queries",result:o.error.errors});let a=r.parameters?.path?.safeParse(t.params);a?.error&&e.addIssue({in:"params",result:a.error.errors});let n=r.parameters?.header?.safeParse(t.headers);n?.error&&e.addIssue({in:"headers",result:n.error.errors});let i=r.parameters?.cookie?.safeParse(t.cookies);if(i?.error&&e.addIssue({in:"cookies",result:i.error.errors}),e.hasIssue())throw e;return{body:s?.data,queries:o?.data??{},params:a?.data??{},headers:n?.data??{},cookies:i?.data??{}}}function ce(t,r,e,s){typeof s=="string"&&console.error(s?`[error:${s}]: ${e}`:`[error]: ${e}`),t.writeHead(r,{"content-type":"application/json"}).end(JSON.stringify({statusCode:r,message:e}))}function ue(t){let r=/:([^/]+)/g,e=D(t).replace(r,"{$1}"),s=[],o=null;for(;(o=r.exec(t))!==null;)s.push(o[1]);return{path:e,params:s}}function D(t){return t.replace(/\/+/gi,"/")}function it(t,r,e){e?.cors&&t.use(Ne(typeof e.cors=="boolean"?{}:e.cors)),console.log(`[server]: Registering ${Object.keys(r).length} endpoints...`);let s=new Set;for(let[o,a]of Object.entries(r)){let[n="",...i]=o.split(":"),l=i.join(":");if(s.has(a.operationId))throw new Error(`Duplicate operation ID "${a.operationId}" for path ${l}`);if(s.add(a.operationId),!me.some(c=>c===n))throw new Error(`Invalid method "${n}" for path ${l}`);console.log(`[register]: ${a.operationId} -> ${n.toUpperCase()} ${l}`),t[n](l,async(c,y)=>{try{let d=await ae(c),f=ie(d,c.headers["content-type"]??""),m={};if(a.security?.length)for(let h of a.security)await h.authenticate(c,m);let p=de({body:f,queries:qe(G.parse(c.url||"",!0).query,h=>{let T=Array.isArray(h)?h:[h];return e?.request?.multiValueQueryString?T:T.at(-1)}),cookies:pe(c.headers.cookie??""),params:c.params,headers:c.headers},a),b=await a.handler(p,{extensions:m,req:c,res:y,...a.security&&{security:a.security}});if(y.headersSent)return;let g=b instanceof _?b:new _({body:b}),B=g.payload.status??(n==="post"?201:200),R=a.responses[B]||a.responses.default;if(!R||typeof R=="boolean"||typeof R=="string")throw console.error(`[error]: There is no corresponding validator defined in schema for status ${B}/default`),new Error("Internal server error");if(g.payload.body instanceof je||g.payload.body instanceof j.ReadStream)y.writeHead(B,g.payload.headers),g.payload.body.pipe(y);else{let h=g.payload.body;try{h=await R.body.parseAsync(g.payload.body)}catch(T){throw console.error("[error]: Invalid output format to the corresponding defined output schema"),console.error(String(T)),new Error("Internal server error")}if(typeof h>"u")y.writeHead(B,g.payload.headers).end();else{let T=await R.serialize(h);y.writeHead(B,{"content-type":R.mimeType,...T.headers,...g.payload.headers}).end(T.buffer)}}}catch(d){let f,m;d instanceof N?(f=d.status,m=d.message):d instanceof S?(f=d.statusCode,m=d.message):d instanceof z?(f=400,m=d.errors):d instanceof Error?(f=500,m=d.message,console.error(String(d))):(f=500,m=String(d),console.error(String(d))),y.writeHead(f,{"content-type":"application/json"}).end(JSON.stringify({statusCode:f,message:m}))}})}if(e?.docs){let o=JSON.stringify(e.docs.spec),a=j.readFileSync(le.join(__dirname,`./templates/${e.docs.viewer}.hbs`),"utf-8").replace("{{title}}",e.docs.spec.info.title).replace("{{specUrl}}",e.docs.specPath).replace("{{theme}}",e.docs.theme??"");t.get(e.docs.specPath,(n,i)=>{i.writeHead(200,{"content-type":"application/json"}).end(o)}),t.get(e.docs.docsPath,(n,i)=>{i.writeHead(200,{"content-type":"text/html"}).end(a)})}t.use(async(o,a)=>{if(await e?.fallbackHandler?.(o,a),a.headersSent)return;let{pathname:n}=G.parse(o.url||"",!0);ce(a,404,`Cannot find ${o.method} ${n}`)})}import{mapValues as Ve}from"radash";import J from"zod";var me=["get","post","put","patch","delete"];function lt(t){return{...t,...t.requestBody&&!(t.requestBody instanceof x)&&{requestBody:new P(t.requestBody)},responses:Object.fromEntries(Object.entries(t.responses).map(([r,e])=>[r,e instanceof J.ZodType?new P(e):e]))}}var _=class t{constructor(r){this.payload=r}static withoutBody(r,e){return e?new t({headers:e,status:r}):new t({status:r})}},ye=class{constructor(r){this.name=r.name,this.schema=r.schema,this.handler=r.handler}apply(r){return new U(this,r)}},U=class{constructor(r,e){this.scopes=e,this.security=r}async authenticate(r,e){await this.security.handler(r,this.scopes,e)}},N=class extends Error{constructor(e,s){super(s);this.status=e;this.msg=s}},x=class{constructor(){this._description=null;this._headers=null;this._examples=null}describe(r){return this._description=r,this}get description(){return this._description}requireHeaders(r){return this._headers=r,this}get requiredHeaders(){return this._headers}setExamples(r){return this._examples=r,this}getExamples(){return this._examples}},V=class V extends x{constructor(e){super();this.body=e}async serialize(e){return{buffer:Buffer.from(JSON.stringify(e)),headers:{}}}get mimeType(){return V.mimeType}};V.mimeType="application/json";var P=V,w=class w extends x{constructor(e,s){super();this.body=e;this.encoding=s}async serialize(e){let s=k();return{buffer:await ne(Ve(e,o=>[o instanceof File?o:String(o)]),s),headers:{"content-type":`${w.mimeType}; boundary=${s}`}}}get mimeType(){return w.mimeType}};w.mimeType="multipart/form-data";var C=w,Z=class Z extends x{constructor(e,s){super();this.body=e;this.encoding=s}async serialize(e){return{buffer:Buffer.from(new URLSearchParams(e instanceof URLSearchParams?e:Object.fromEntries(Object.entries(e).map(([s,o])=>[s,String(o)]))).toString()),headers:{}}}get mimeType(){return Z.mimeType}};Z.mimeType="application/x-www-form-urlencoded";var q=Z,v=class v extends x{constructor(e=J.instanceof(Buffer)){super();this.body=e}async serialize(e){return{buffer:e,headers:{}}}get mimeType(){return v.mimeType}};v.mimeType="application/octet-stream";var O=v,M=class M extends x{constructor(e=J.string()){super();this.body=e}async serialize(e){return{buffer:Buffer.from(e),headers:{}}}get mimeType(){return M.mimeType}};M.mimeType="text/plain";var F=M,H=class H extends F{get mimeType(){return H.mimeType}};H.mimeType="text/html";var fe=H;import L from"http-status";import{isEmpty as X,mapEntries as Ze,mapValues as ge,pascal as K,shake as ve,title as Q}from"radash";import{z as u}from"zod";import Me from"zod-to-json-schema";var $="GeneralApiError",he="ValidationError",He=u.object({code:u.enum(["invalid_type","invalid_literal","unrecognized_keys","invalid_union","invalid_union_discriminator","invalid_enum_value","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite","custom"]),path:u.union([u.string(),u.number().int().min(0)]).array(),fatal:u.boolean().optional(),message:u.string()}).passthrough(),Le=u.object({in:u.enum(["body","queries","params","headers","cookies"]).describe("The part of a request where data validation failed"),result:u.array(He).describe("An array of error items")}),Te=u.object({statusCode:u.number().int().min(100).max(599).describe("The HTTP response status code"),message:u.string().describe("The message associated with the error")}).describe("A general HTTP error response"),$e=Te.extend({message:u.union([u.array(Le).describe("An array of error schemas detailing validation issues"),u.string().describe("Alternatively, a simple error message")])}).describe("An error related to the validation process with more detailed information"),ke=["https://spec.openapis.org/oas/3.1/dialect/base","https://spec.openapis.org/oas/3.1/dialect/2024-11-10"];function St(t){let r={},e=new Set,s=new Set,o={};for(let[a,n]of Object.entries(t.paths)){if(n.hidden)continue;let[i,...l]=a.split(":"),{path:c}=ue(l.join(":")),y=[],d=r[c]??{};for(let p of n.security??[])e.add(p.security);for(let p of n.tags??[])s.add(p);for(let[p,b]of Object.entries(n.parameters??{})){let{properties:g={},required:B=[]}=I(b);for(let[R,h]of Object.entries(g)){if("$ref"in h)continue;let{description:T,...be}=h,Y=B.includes(R);y.push({name:R,in:p,...T&&{description:T},...Y&&{required:Y},schema:be})}}let f=`${K(Q(n.operationId))}RequestBody`;n.requestBody&&n.requestBody.body._def.typeName!==u.ZodVoid.name&&!(n.requestBody instanceof O)&&(o[f]=I(n.requestBody.body,n.requestBody.mimeType));let m=`${K(Q(n.operationId))}Response`;for(let[,p]of Object.entries(n.responses??{}))p instanceof O||typeof p=="object"&&p.body._def.typeName!==u.ZodVoid.name&&(o[m]=I(p.body,p.mimeType));d[i]={...n.tags?.length&&{tags:Object.values(n.tags).map(p=>p.name)},summary:n.summary||n.operationId,...n.description&&{description:n.description},operationId:n.operationId,...n.deprecated&&{deprecated:n.deprecated},...!X(y)&&{parameters:y},...n.security?.length&&{security:n.security.map(p=>({[p.security.name]:p.scopes}))},...n.requestBody&&{requestBody:{...n.requestBody.description&&{description:n.requestBody.description},content:A(n.requestBody.mimeType,f,n.requestBody.body._def.typeName===u.ZodVoid.name||n.requestBody instanceof O,n.requestBody instanceof C||n.requestBody instanceof q?n.requestBody.encoding:void 0),required:!n.requestBody.body.isOptional()}},responses:{...ge(ve(n.responses),(p,b)=>({description:(typeof p=="string"?p:null)||String(L[`${b}`])||"No description",content:typeof p=="boolean"||typeof p=="string"?A(P.mimeType,$):A(p.mimeType,m,p.body._def.typeName===u.ZodVoid.name||p instanceof O)})),...(n.requestBody||!X(n.parameters))&&{400:{description:W(n.responses,400)||L[400],content:A(P.mimeType,he)}},...n.security?.length&&{401:{description:W(n.responses,401)||L[401],content:A(P.mimeType,$)}},500:{description:W(n.responses,500)||L[500],content:A(P.mimeType,$)}}},r[c]=d}return{openapi:t.openapi,info:t.info,jsonSchemaDialect:t.jsonSchemaDialect??ke[0],paths:r,...t.webhooks&&{webhooks:t.webhooks},components:{schemas:{...o,[$]:I(Te),[he]:I($e),...Ze(t.additionalSchemas??{},(a,n)=>[K(Q(a)),I(n)])},...e.size&&{securitySchemes:Object.fromEntries([...e.values()].map(a=>[a.name,a.schema]))}},tags:[...s.values()],...t.externalDocs&&{externalDocs:t.externalDocs}}}function A(t,r,e,s){return e?{[t]:{}}:{[t]:{schema:{$ref:`#/components/schemas/${r}`},...s&&{encoding:ge(s,o=>({...o,...o.contentType&&{contentType:o.contentType.join(", ")},...o.headers&&{headers:I(o.headers).properties}}))}}}}function W(t,r){let e=t[r];return typeof e=="string"?e:null}function I(t,r){let e=Me(t,{target:"jsonSchema2019-09",$refStrategy:"none"});if(r===C.mimeType)for(let s in e.properties??{})e.properties&&X(e.properties[s])&&(e.properties[s]={type:"string",format:"binary",contentMediaType:"application/octet-stream"});return delete e.$schema,e}import{mapKeys as Ge,mapValues as Ue}from"radash";function It(t,r){let e=[],s=[];for(let o of r){let a=Object.keys(o).map(n=>D(`${t}${n}`));s.push(...e.filter(n=>a.includes(n))),e.push(...a)}if(s.length)throw new Error(`Duplicated keys occured: ${s.join(", ")}`);return Ge(Object.assign({},...r),o=>D(o.replace(/:/,`:${t}`)))}function At(t,r){return Ue(t,e=>Object.assign(e,r))}var export_oas3=Fe.OpenAPIV3_1;export{N as ApiError,U as AppliedSecurity,C as FormDataBody,fe as HtmlBody,_ as HttpResponse,P as JsonBody,me as METHODS,O as OctetStreamBody,ye as Security,F as TextBody,q as UrlEncodedBody,At as applyGroupConfig,St as buildJson,it as createApi,lt as endpoint,It as mergeEndpointGroups,export_oas3 as oas3};
//# sourceMappingURL=index.mjs.map