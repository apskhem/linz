var Te=Object.create;var Y=Object.defineProperty;var be=Object.getOwnPropertyDescriptor;var Re=Object.getOwnPropertyNames;var Pe=Object.getPrototypeOf,Se=Object.prototype.hasOwnProperty;var Ee=(t,r)=>()=>(r||t((r={exports:{}}).exports,r),r.exports);var xe=(t,r,e,n)=>{if(r&&typeof r=="object"||typeof r=="function")for(let s of Re(r))!Se.call(t,s)&&s!==e&&Y(t,s,{get:()=>r[s],enumerable:!(n=be(r,s))||n.enumerable});return t};var Oe=(t,r,e)=>(e=t!=null?Te(Pe(t)):{},xe(r||!t||!t.__esModule?Y(e,"default",{value:t,enumerable:!0}):e,t));var ee=Ee(P=>{"use strict";P.__esModule=!0;P.OpenAPIV2=P.OpenAPIV3=void 0;var Be;(function(t){var r;(function(e){e.GET="get",e.PUT="put",e.POST="post",e.DELETE="delete",e.OPTIONS="options",e.HEAD="head",e.PATCH="patch",e.TRACE="trace"})(r=t.HttpMethods||(t.HttpMethods={}))})(Be=P.OpenAPIV3||(P.OpenAPIV3={}));var Ie;(function(t){var r;(function(e){e.GET="get",e.PUT="put",e.POST="post",e.DELETE="delete",e.OPTIONS="options",e.HEAD="head",e.PATCH="patch"})(r=t.HttpMethods||(t.HttpMethods={}))})(Ie=P.OpenAPIV2||(P.OpenAPIV2={}))});var Ge=Oe(ee());export*from"@routejs/router";import*as q from"fs";import*as ce from"path";import{Readable as qe}from"stream";import*as $ from"url";import Ce from"cors";import{mapValues as De}from"radash";import{parse as ne}from"fast-content-type-parse";import{randomBytes as Ae}from"crypto";function te(t,r){let e="",n=0,s=[],a=[],o=[],u={};for(let p=0;p<t.length;p++){let d=t[p]??NaN,m=p>0?t[p-1]??null:null,c=d===10&&m===13;if(d===10||d===13||(e+=String.fromCharCode(d)),n===0&&c)`--${r}`===e&&(n=1),e="";else if(n===1&&c)e.length?o.push(e):(u=Object.fromEntries(o.flatMap(y=>{let[i,T=""]=y.split(":");return i?.trim()?[[i.trim().toLowerCase(),T?.trim()]]:[]})),n=2,s=[]),e="";else if(n===2){if(e.length>r.length+4&&(e=""),`--${r}`===e){let y=s.length-e.length,i=s.slice(0,y-1);a.push(ze({headers:u,part:i})),s=[],o=[],u={},e="",n=3}else s.push(d);c&&(e="")}else n===3&&c&&(n=1)}return a}function ze(t){let r=_e(t.headers["content-disposition"]??"");return{headers:t.headers,name:r.name,data:Buffer.from(t.part),...r.filename&&{filename:r.filename,type:t.headers["content-type"]?.trim()}}}function _e(t){let r={type:null,name:null,filename:null},e=t.split(";").map(n=>n.trim());e[0]&&(r.type=e[0].toLowerCase());for(let n of e.slice(1)){let[s,a]=n.split("=").map(o=>o.trim());s&&a&&(r[s.toLowerCase()]=a.replace(/^"|"$/g,""))}return r}function L(t="----------------------"){return`--${t}${Ae(12).toString("hex")}`}async function re(t,r=L()){let e=[];for(let[n,s]of Object.entries(t))for(let a of s)e.push(Buffer.from(`--${r}`)),typeof a=="string"?e.push(Buffer.from(`Content-Disposition: form-data; name="${n}"\r
\r
`),Buffer.from(a),Buffer.from(`\r
`)):a instanceof File&&e.push(Buffer.from(`Content-Disposition: form-data; name="${n}"; filename="${a.name}"\r
`),Buffer.from(`Content-Type: ${a.type||"application/octet-stream"}\r
\r
`),Buffer.from(await a.arrayBuffer()),Buffer.from(`\r
`));return e.push(Buffer.from(`--${r}--\r
`)),Buffer.concat(e)}var S=class extends Error{constructor(r,e){super(e),this.statusCode=r}};function oe(t){return new Promise((r,e)=>{let n=[];t.on("data",s=>n.push(s)),t.on("end",()=>r(Buffer.concat(n))),t.on("error",s=>e(s))})}function se(t,r,e){let n;try{n=ne(r??"")}catch(s){throw new S(400,String(s))}if(t.length)if(n.type==="application/json")try{JSON.parse(t.toString(n.parameters.charset??"utf-8"))}catch{throw new S(400,"Invalid JSON")}else if(n.type==="multipart/form-data"){let s=n.parameters.boundary?.trim().replace(/^["']|["']$/g,"");if(!s)throw new S(400,"Cannot find multipart boundary");let a=te(t,s),o={},u={};for(let p of a){let d=p.headers["content-type"],m=d?ne(d):null;if(!p.name)continue;let c=p.filename?new File([p.data],p.filename,p.type?{type:p.type}:{}):p.data.toString(m?.parameters.charset??"utf-8");e?.multiValueFormData?(o[p.name]??=[]).push(c):u[p.name]=c}return e?.multiValueFormData?o:u}else if(n.type==="application/x-www-form-urlencoded"){let s=t.toString(n.parameters.charset??"utf-8"),a=new URLSearchParams(s),o={},u={};for(let[p,d]of a.entries())e?.multiValueUrlEncoded?(o[p]??=[]).push(d):u[p]=d;return e?.multiValueUrlEncoded?o:u}else{if(n.type==="application/octet-stream")return t;{let s=`'${n.type}' content type is not supported`;throw new S(415,s)}}else return null}function ae(t){return t.split(";").reduce((r,e)=>{let[n,...s]=e.trim().split("=");return n&&(r[n]=decodeURIComponent(s.join("="))),r},{})}function ie(t,r,e){let n=[],s=e.requestBody?.body.safeParse(t.body);s.error&&n.push({in:"body",result:s.error.errors});let a=e.parameters?.query?.safeParse(t.query);a?.error&&n.push({in:"queries",result:a.error.errors});let o=e.parameters?.path?.safeParse(t.params);o?.error&&n.push({in:"params",result:o.error.errors});let u=e.parameters?.header?.safeParse(t.headers);u?.error&&n.push({in:"headers",result:u.error.errors});let p=e.parameters?.cookie?.safeParse(t.cookies);return p?.error&&n.push({in:"cookies",result:p.error.errors}),n.length?(r.writeHead(400,{"content-type":"application/json"}).end(JSON.stringify(n)),null):{body:s?.data??null,queries:a?.data??{},params:o?.data??{},headers:u?.data??{},cookies:p?.data??{}}}function pe(t,r,e,n){typeof n=="string"&&console.error(n?`[error:${n}]: ${e}`:`[error]: ${e}`),t.writeHead(r,{"content-type":"application/json"}).end(JSON.stringify({statusCode:r,message:e}))}function de(t){let r=/:([^/]+)/g,e=w(t).replace(r,"{$1}"),n=[],s=null;for(;(s=r.exec(t))!==null;)n.push(s[1]);return{path:e,params:n}}function w(t){return t.replace(/\/+/gi,"/")}function ot(t,r,e){e?.cors&&t.use(Ce(typeof e.cors=="boolean"?{}:e.cors)),console.log(`[server]: Registering ${Object.keys(r).length} endpoints...`);let n=new Set;for(let[s,a]of Object.entries(r)){let[o="",...u]=s.split(":"),p=u.join(":");if(n.has(a.operationId))throw new Error(`Duplicate operation ID "${a.operationId}" for path ${p}`);if(n.add(a.operationId),!ue.some(d=>d===o))throw new Error(`Invalid method "${o}" for path ${p}`);console.log(`[register]: ${a.operationId} -> ${o.toUpperCase()} ${p}`),t[o](p,async(d,m)=>{try{let c=await oe(d),f=se(c,d.headers["content-type"]??""),y={};if(a.security?.length)for(let g of a.security)await g.authenticate(d,y);let i=ie({body:f,query:De($.parse(d.url||"",!0).query,g=>e?.request?.multiValueQueryString?g?.at(-1):g),cookies:ae(d.headers.cookie??""),params:d.params,headers:d.headers},m,a),T=await a.handler(i,{extensions:y,req:d,res:m,...a.security&&{security:a.security}}),h=T instanceof A?T:new A({body:T}),x=h.payload.status??(o==="post"?201:200),b=a.responses[x]||a.responses.default;if(!b||typeof b=="boolean"||typeof b=="string")throw console.error(`[error]: There is no corresponding validator defined in schema for status ${x}/default`),new Error("Internal server error");try{b.body.parse(h.payload.body)}catch(g){throw console.error("[error]: Invalid output format to the corresponding defined output schema"),console.error(String(g)),new Error("Internal server error")}if(h.payload.body instanceof qe||h.payload.body instanceof q.ReadStream)m.writeHead(x,h.payload.headers),h.payload.body.pipe(m);else if(typeof h.payload.body>"u")m.writeHead(x,h.payload.headers).end();else{let g=await b.serialize(h.payload.body);m.writeHead(x,{"content-type":b.mimeType,...g.headers,...h.payload.headers}).end(g.buffer)}}catch(c){let f,y;c instanceof C?(f=c.status,y=c.message):c instanceof S?(f=c.statusCode,y=c.message):c instanceof Error?(f=500,y=c.message,console.error(String(c))):(f=500,y=String(c),console.error(String(c))),m.writeHead(f,{"content-type":"application/json"}).end(JSON.stringify({statusCode:f,message:y}))}})}if(e?.docs){let s=JSON.stringify(e.docs.spec),a=q.readFileSync(ce.join(__dirname,`./templates/${e.docs.viewer}.hbs`),"utf-8").replace("{{title}}",e.docs.spec.info.title).replace("{{specUrl}}",e.docs.specPath).replace("{{theme}}",e.docs.theme??"");t.get(e.docs.specPath,(o,u)=>{u.writeHead(200,{"content-type":"application/json"}).end(s)}),t.get(e.docs.docsPath,(o,u)=>{u.writeHead(200,{"content-type":"text/html"}).end(a)})}t.use(async(s,a)=>{if(await e?.fallbackHandler?.(s,a),a.headersSent)return;let{pathname:o}=$.parse(s.url||"",!0);pe(a,404,`Cannot find ${s.method} ${o}`)})}import{mapValues as je}from"radash";import F from"zod";var ue=["get","post","put","patch","delete"];function dt(t){return{...t,...t.requestBody&&!(t.requestBody instanceof E)&&{requestBody:new R(t.requestBody)},responses:Object.fromEntries(Object.entries(t.responses).map(([r,e])=>[r,e instanceof F.ZodType?new R(e):e]))}}var A=class t{constructor(r){this.payload=r}static withoutBody(r,e){return e?new t({headers:e,status:r}):new t({status:r})}},le=class{constructor(r){this.name=r.name,this.schema=r.schema,this.handler=r.handler}apply(r){return new k(this,r)}},k=class{constructor(r,e){this.scopes=e,this.security=r}async authenticate(r,e){await this.security.handler(r,this.scopes,e)}},C=class extends Error{constructor(e,n){super(n);this.status=e;this.msg=n}},E=class{constructor(){this._description=null;this._headers=null;this._examples=null}describe(r){return this._description=r,this}get description(){return this._description}requireHeaders(r){return this._headers=r,this}get requiredHeaders(){return this._headers}setExamples(r){return this._examples=r,this}getExamples(){return this._examples}},j=class j extends E{constructor(e){super();this.body=e}async serialize(e){return{buffer:Buffer.from(JSON.stringify(e)),headers:{}}}get mimeType(){return j.mimeType}};j.mimeType="application/json";var R=j,z=class z extends E{constructor(e,n){super();this.body=e;this.encoding=n}async serialize(e){let n=L();return{buffer:await re(je(e,s=>[s instanceof File?s:String(s)]),n),headers:{"content-type":`${z.mimeType}; boundary=${n}`}}}get mimeType(){return z.mimeType}};z.mimeType="multipart/form-data";var _=z,N=class N extends E{constructor(e,n){super();this.body=e;this.encoding=n}async serialize(e){return{buffer:Buffer.from(new URLSearchParams(e instanceof URLSearchParams?e:Object.fromEntries(Object.entries(e).map(([n,s])=>[n,String(s)]))).toString()),headers:{}}}get mimeType(){return N.mimeType}};N.mimeType="application/x-www-form-urlencoded";var D=N,v=class v extends E{constructor(e=F.instanceof(Buffer)){super();this.body=e}async serialize(e){return{buffer:e,headers:{}}}get mimeType(){return v.mimeType}};v.mimeType="application/octet-stream";var O=v,V=class V extends E{constructor(e=F.string()){super();this.body=e}async serialize(e){return{buffer:Buffer.from(e),headers:{}}}get mimeType(){return V.mimeType}};V.mimeType="text/plain";var G=V,Z=class Z extends G{get mimeType(){return Z.mimeType}};Z.mimeType="text/html";var me=Z;import H from"http-status";import{isEmpty as Q,mapEntries as Ne,mapValues as fe,pascal as J,shake as ve,title as U}from"radash";import{z as l}from"zod";import Ve from"zod-to-json-schema";var M="GeneralApiError",ye="ValidationError",Ze=l.object({code:l.enum(["invalid_type","invalid_literal","unrecognized_keys","invalid_union","invalid_union_discriminator","invalid_enum_value","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite","custom"]),path:l.union([l.string(),l.number().int().min(0)]).array(),fatal:l.boolean().optional(),message:l.string()}).passthrough(),He=l.object({in:l.enum(["body","queries","params","headers","cookies"]).describe("The part of a request where data validation failed"),result:l.array(Ze).describe("An array of error items")}),he=l.object({statusCode:l.number().int().min(100).max(599).describe("The HTTP response status code"),message:l.string().describe("The message associated with the error")}).describe("A general HTTP error response"),Me=he.extend({message:l.union([l.array(He).describe("An array of error schemas detailing validation issues"),l.string().describe("Alternatively, a simple error message")])}).describe("An error related to the validation process with more detailed information"),Le=["https://spec.openapis.org/oas/3.1/dialect/base","https://spec.openapis.org/oas/3.1/dialect/2024-11-10"];function Rt(t){let r={},e=new Set,n=new Set,s={};for(let[a,o]of Object.entries(t.paths)){let[u,...p]=a.split(":"),{path:d}=de(p.join(":")),m=[],c=r[d]??{};for(let i of o.security??[])e.add(i.security);for(let i of o.tags??[])n.add(i);for(let[i,T]of Object.entries(o.parameters??{})){let{properties:h={},required:x=[]}=B(T);for(let[b,g]of Object.entries(h)){if("$ref"in g)continue;let{description:W,...ge}=g,X=x.includes(b);m.push({name:b,in:i,...W&&{description:W},...X&&{required:X},schema:ge})}}let f=`${J(U(o.operationId))}RequestBody`;o.requestBody&&o.requestBody.body._def.typeName!==l.ZodVoid.name&&!(o.requestBody instanceof O)&&(s[f]=B(o.requestBody.body,o.requestBody.mimeType));let y=`${J(U(o.operationId))}Response`;for(let[,i]of Object.entries(o.responses??{}))i instanceof O||typeof i=="object"&&i.body._def.typeName!==l.ZodVoid.name&&(s[y]=B(i.body,i.mimeType));c[u]={...o.tags?.length&&{tags:Object.values(o.tags).map(i=>i.name)},summary:o.summary||o.operationId,...o.description&&{description:o.description},operationId:o.operationId,...o.deprecated&&{deprecated:o.deprecated},...!Q(m)&&{parameters:m},...o.security?.length&&{security:o.security.map(i=>({[i.security.name]:i.scopes}))},...o.requestBody&&{requestBody:{...o.requestBody.description&&{description:o.requestBody.description},content:I(o.requestBody.mimeType,f,o.requestBody.body._def.typeName===l.ZodVoid.name||o.requestBody instanceof O,o.requestBody instanceof _||o.requestBody instanceof D?o.requestBody.encoding:void 0),required:!o.requestBody.body.isOptional()}},responses:{...fe(ve(o.responses),(i,T)=>({description:(typeof i=="string"?i:null)||String(H[`${T}`])||"No description",content:typeof i=="boolean"||typeof i=="string"?I(R.mimeType,M):I(i.mimeType,y,i.body._def.typeName===l.ZodVoid.name||i instanceof O)})),...(o.requestBody||!Q(o.parameters))&&{400:{description:K(o.responses,400)||H[400],content:I(R.mimeType,ye)}},...o.security?.length&&{401:{description:K(o.responses,401)||H[401],content:I(R.mimeType,M)}},500:{description:K(o.responses,500)||H[500],content:I(R.mimeType,M)}}},r[d]=c}return{openapi:t.openapi,info:t.info,jsonSchemaDialect:t.jsonSchemaDialect??Le[0],paths:r,...t.webhooks&&{webhooks:t.webhooks},components:{schemas:{...s,[M]:B(he),[ye]:B(Me),...Ne(t.additionalSchemas??{},(a,o)=>[J(U(a)),B(o)])},...e.size&&{securitySchemes:Object.fromEntries([...e.values()].map(a=>[a.name,a.schema]))}},tags:[...n.values()],...t.externalDocs&&{externalDocs:t.externalDocs}}}function I(t,r,e,n){return e?{[t]:{}}:{[t]:{schema:{$ref:`#/components/schemas/${r}`},...n&&{encoding:fe(n,s=>({...s,...s.contentType&&{contentType:s.contentType.join(", ")},...s.headers&&{headers:B(s.headers).properties}}))}}}}function K(t,r){let e=t[r];return typeof e=="string"?e:null}function B(t,r){let e=Ve(t,{target:"jsonSchema2019-09",$refStrategy:"none"});if(r===_.mimeType)for(let n in e.properties??{})e.properties&&Q(e.properties[n])&&(e.properties[n]={type:"string",contentMediaType:"application/octet-stream"});return delete e.$schema,e}import{mapKeys as $e,mapValues as ke}from"radash";function xt(t,r){let e=[],n=[];for(let s of r){let a=Object.keys(s).map(o=>w(`${t}${o}`));n.push(...e.filter(o=>a.includes(o))),e.push(...a)}if(n.length)throw new Error(`Duplicated keys occured: ${n.join(", ")}`);return $e(Object.assign({},...r),s=>w(s.replace(/:/,`:${t}`)))}function Ot(t,r){return ke(t,e=>Object.assign(e,r))}var export_oas3=Ge.OpenAPIV3_1;export{C as ApiError,k as AppliedSecurity,_ as FormDataBody,me as HtmlBody,A as HttpResponse,R as JsonBody,ue as METHODS,O as OctetStreamBody,le as Security,G as TextBody,D as UrlEncodedBody,Ot as applyGroupConfig,Rt as buildJson,ot as createApi,dt as endpoint,xt as mergeEndpointGroups,export_oas3 as oas3};
//# sourceMappingURL=index.mjs.map