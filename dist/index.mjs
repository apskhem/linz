var Re=Object.create;var re=Object.defineProperty;var Oe=Object.getOwnPropertyDescriptor;var Se=Object.getOwnPropertyNames;var Ee=Object.getPrototypeOf,Pe=Object.prototype.hasOwnProperty;var Be=(t,r)=>()=>(r||t((r={exports:{}}).exports,r),r.exports);var xe=(t,r,e,n)=>{if(r&&typeof r=="object"||typeof r=="function")for(let o of Se(r))!Pe.call(t,o)&&o!==e&&re(t,o,{get:()=>r[o],enumerable:!(n=Oe(r,o))||n.enumerable});return t};var Ae=(t,r,e)=>(e=t!=null?Re(Ee(t)):{},xe(r||!t||!t.__esModule?re(e,"default",{value:t,enumerable:!0}):e,t));var ne=Be(O=>{"use strict";O.__esModule=!0;O.OpenAPIV2=O.OpenAPIV3=void 0;var Ie;(function(t){var r;(function(e){e.GET="get",e.PUT="put",e.POST="post",e.DELETE="delete",e.OPTIONS="options",e.HEAD="head",e.PATCH="patch",e.TRACE="trace"})(r=t.HttpMethods||(t.HttpMethods={}))})(Ie=O.OpenAPIV3||(O.OpenAPIV3={}));var ze;(function(t){var r;(function(e){e.GET="get",e.PUT="put",e.POST="post",e.DELETE="delete",e.OPTIONS="options",e.HEAD="head",e.PATCH="patch"})(r=t.HttpMethods||(t.HttpMethods={}))})(ze=O.OpenAPIV2||(O.OpenAPIV2={}))});var Fe=Ae(ne());export*from"@routejs/router";import*as $ from"fs";import*as ye from"path";import{Readable as ve}from"stream";import*as K from"url";import ke from"cors";import{mapValues as Ce}from"radash";import{randomBytes as _e}from"crypto";function se(t,r){let e="",n=0,o=[],i=[],s=[],m={};for(let d=0;d<t.length;d++){let p=t[d]??NaN,u=d>0?t[d-1]??null:null,g=p===10&&u===13;if(p===10||p===13||(e+=String.fromCharCode(p)),n===0&&g)`--${r}`===e&&(n=1),e="";else if(n===1&&g)e.length?s.push(e):(m=Object.fromEntries(s.flatMap(y=>{let[a,l=""]=y.split(":");return a?.trim()?[[a.trim().toLowerCase(),l?.trim()]]:[]})),n=2,o=[]),e="";else if(n===2){if(e.length>r.length+4&&(e=""),`--${r}`===e){let y=o.length-e.length,a=o.slice(0,y-1);i.push(we({headers:m,part:a})),o=[],s=[],m={},e="",n=3}else o.push(p);g&&(e="")}else n===3&&g&&(n=1)}return i}function oe(t){let r=t.split(";");for(let e of r){let n=String(e).trim();if(n.startsWith("boundary")){let o=n.split("=");return String(o[1]).trim().replace(/^["']|["']$/g,"")}}return null}function we(t){let r=je(t.headers["content-disposition"]??"");return{headers:t.headers,name:r.name,data:Buffer.from(t.part),...r.filename&&{filename:r.filename,type:t.headers["content-type"]?.trim()}}}function je(t){let r={type:null,name:null,filename:null},e=t.split(";").map(n=>n.trim());e[0]&&(r.type=e[0].toLowerCase());for(let n of e.slice(1)){let[o,i]=n.split("=").map(s=>s.trim());o&&i&&(r[o.toLowerCase()]=i.replace(/^"|"$/g,""))}return r}function G(t="----------------------"){return`--${t}${_e(12).toString("hex")}`}async function ie(t,r=G()){let e=[];for(let[n,o]of Object.entries(t))for(let i of o)e.push(Buffer.from(`--${r}`)),typeof i=="string"?e.push(Buffer.from(`Content-Disposition: form-data; name="${n}"\r
\r
`),Buffer.from(i),Buffer.from(`\r
`)):i instanceof File&&e.push(Buffer.from(`Content-Disposition: form-data; name="${n}"; filename="${i.name}"\r
`),Buffer.from(`Content-Type: ${i.type||"application/octet-stream"}\r
\r
`),Buffer.from(await i.arrayBuffer()),Buffer.from(`\r
`));return e.push(Buffer.from(`--${r}--\r
`)),Buffer.concat(e)}import{mapValues as De}from"radash";import F from"zod";var de=["get","post","put","patch","delete"];function tt(t){return{...t,...t.requestBody&&!(t.requestBody instanceof S)&&{requestBody:new h(t.requestBody)},responses:Object.fromEntries(Object.entries(t.responses).map(([r,e])=>[r,e instanceof F.ZodType?new h(e):e]))}}var _=class t{constructor(r){this.payload=r}static withoutBody(r,e){return e?new t({headers:e,status:r}):new t({status:r})}},ae=class{constructor(r){this.name=r.name,this.schema=r.schema,this.handler=r.handler}apply(r){return new J(this,r)}},J=class{constructor(r,e){this.scopes=e,this.security=r}async authenticate(r,e){await this.security.handler(r,this.scopes,e)}},N=class extends Error{constructor(e,n){super(n);this.status=e;this.msg=n}},A=class extends Error{constructor(e){super(JSON.stringify(e));this.msg=e}},S=class{constructor(){this._description=null;this._headers=null;this._examples=null}describe(r){return this._description=r,this}get description(){return this._description}requireHeaders(r){return this._headers=r,this}get requiredHeaders(){return this._headers}setExamples(r){return this._examples=r,this}getExamples(){return this._examples}},C=class C extends S{constructor(e){super();this.body=e}async serialize(e){return Buffer.from(JSON.stringify(e))}get mimeType(){return C.mimeType}};C.mimeType="application/json";var h=C,z=class z extends S{constructor(e,n){super();this.body=e;this.encoding=n}async serialize(e){return(await this.serializeWithContentType(e))[1]}async serializeWithContentType(e){let n=G();return[`${z.mimeType}; boundary=${n}`,await ie(De(e,o=>[o instanceof File?o:String(o)]),n)]}get mimeType(){return z.mimeType}};z.mimeType="multipart/form-data";var E=z,v=class v extends S{constructor(e,n){super();this.body=e;this.encoding=n}async serialize(e){return Buffer.from(new URLSearchParams(e instanceof URLSearchParams?e:Object.fromEntries(Object.entries(e).map(([n,o])=>[n,String(o)]))).toString())}get mimeType(){return v.mimeType}};v.mimeType="application/x-www-form-urlencoded";var D=v,k=class k extends S{constructor(e=F.instanceof(Buffer)){super();this.body=e}async serialize(e){return e}get mimeType(){return k.mimeType}};k.mimeType="application/octet-stream";var P=k,Z=class Z extends S{constructor(e=F.string()){super();this.body=e}async serialize(e){return Buffer.from(e)}get mimeType(){return Z.mimeType}};Z.mimeType="text/plain";var U=Z,H=class H extends U{get mimeType(){return H.mimeType}};H.mimeType="text/html";var pe=H;function ce(t,r){let e={},n=w(()=>r.requestBody?.body.parse(t.body)||t.body,d=>e.body=JSON.parse(d.message)),o=w(()=>r.parameters?.query?.parse(t.query)||t.query,d=>e.queries=JSON.parse(d.message)),i=w(()=>r.parameters?.path?.parse(t.params)||t.params,d=>e.params=JSON.parse(d.message)),s=w(()=>r.parameters?.header?.parse(t.headers)||t.headers,d=>e.headers=JSON.parse(d.message)),m=w(()=>r.parameters?.cookie?.parse(t.cookies)||t.cookies,d=>e.cookies=JSON.parse(d.message));if(Object.keys(e).length)throw new A(e);return{body:n??null,queries:o??{},params:i??{},headers:s??{},cookies:m??{}}}function T(t,r,e,n){typeof n=="string"&&console.error(n?`[error:${n}]: ${e}`:`[error]: ${e}`),t.writeHead(r,{"content-type":"application/json"}).end(JSON.stringify({statusCode:r,message:e}))}function me(t){let r=/:([^/]+)/g,e=L(t).replace(r,"{$1}"),n=[],o=null;for(;(o=r.exec(t))!==null;)n.push(o[1]);return{path:e,params:n}}function L(t){return t.replace(/\/+/gi,"/")}function w(t,r){try{return t()}catch(e){return r(e),null}}function ue(t,r,e){let n=[];t.on("data",o=>n.push(o)),t.on("end",async()=>{if(t.method==="GET"||!n.length)return e();if(t.headers["content-type"]==="application/json"){let o=Buffer.concat(n);try{o.length&&Object.assign(t,{body:JSON.parse(o.toString("utf-8"))})}catch{return T(r,400,"Invalid JSON")}return e()}else if(t.headers["content-type"]?.startsWith("multipart/form-data")){let o=Buffer.concat(n),i=oe(t.headers["content-type"]);if(!i)return T(r,400,"Cannot find multipart boundary");let s=se(o,i),m={};for(let p of s){if(!p.name)continue;let u=p.filename?new File([p.data],p.filename,p.type?{type:p.type}:{}):p.data.toString("utf-8");(m[p.name]??=[]).push(u)}let d=[];for(let[p,u=[]]of Object.entries(m))u.length>1&&d.push({field:p,message:"Duplicated key"});return d.length?T(r,400,JSON.stringify({in:"body",result:d.map(({field:p,message:u})=>({path:[p],message:u}))})):(Object.assign(t,{body:Ce(m,p=>p[0])}),e())}else if(t.headers["content-type"]==="application/x-www-form-urlencoded"){let o=Buffer.concat(n).toString("utf-8"),i=new URLSearchParams(o),s=[];return Array.from(i.keys()).reduce((m,d)=>(m.has(d)&&s.push(d),m.add(d)),new Set),s.length?T(r,400,JSON.stringify({in:"body",result:s.map(m=>({path:[m],message:"Duplicated key"}))})):(Object.assign(t,{body:Object.fromEntries(i)}),e())}else return t.headers["content-type"]==="application/octet-stream"?(Object.assign(t,{body:Buffer.concat(n)}),e()):T(r,415,`'${t.headers["content-type"]}' content type is not supported`)}),t.on("error",o=>{T(r,500,String(o))})}function le(t=""){return t.split(";").reduce((r,e)=>{let[n,...o]=e.trim().split("=");return n&&(r[n]=decodeURIComponent(o.join("="))),r},{})}var V={"content-type":"application/json"};function lt(t,r,e){e?.cors&&t.use(ke(typeof e.cors=="boolean"?{}:e.cors)),t.use(ue),console.log(`[server]: Registering ${Object.keys(r).length} endpoints...`);let n=new Set;for(let[o,i]of Object.entries(r)){let[s="",...m]=o.split(":"),d=m.join(":");if(n.has(i.operationId))throw new Error(`Duplicate operation ID "${i.operationId}" for path ${d}`);if(n.add(i.operationId),!de.some(p=>p===s))throw new Error(`Invalid method "${s}" for path ${d}`);console.log(`[register]: ${i.operationId} -> ${s.toUpperCase()} ${d}`),t[s](d,async(p,u)=>{let g=K.parse(p.url||"",!0);Object.assign(p,{query:g.query,cookies:le(p.headers.cookie)});let x={};try{if(i.security?.length)for(let R of i.security)await R.authenticate(p,x);let y=ce(p,i),a=await i.handler(y,{extensions:x,req:p,...i.security&&{security:i.security}}),l=a instanceof _?a:new _({body:a}),b=l.payload.status??(s==="post"?201:200),f=i.responses[b]||i.responses.default;if(!f||typeof f=="boolean"||typeof f=="string")throw console.error(`[error]: There is no corresponding validator defined in schema for status ${b}/default`),new Error("Internal server error");try{f.body.parse(l.payload.body)}catch(R){throw console.error("[error]: Invalid output format to the corresponding defined output schema"),console.error(String(R)),new Error("Internal server error")}if(l.payload.body instanceof ve||l.payload.body instanceof $.ReadStream)u.writeHead(b,l.payload.headers),l.payload.body.pipe(u);else if(typeof l.payload.body>"u")u.writeHead(b,l.payload.headers).end();else if(f instanceof E){let[R,j]=await f.serializeWithContentType(l.payload.body);u.writeHead(b,{"content-type":R,...l.payload.headers}).end(j)}else u.writeHead(b,{"content-type":f.mimeType,...l.payload.headers}).end(await f.serialize(l.payload.body))}catch(y){Ze(y,u)}})}e?.docs&&He(t,e.docs),t.use(async(o,i)=>{if(await e?.fallbackHandler?.(o,i)??Promise.resolve(null),i.headersSent)return;let{pathname:s}=K.parse(o.url||"",!0);T(i,404,`Cannot find ${o.method} ${s}`)})}function Ze(t,r){t instanceof N?r.writeHead(t.status,V).end(JSON.stringify({statusCode:t.status,message:t.message})):t instanceof A?r.writeHead(400,V).end(JSON.stringify({statusCode:400,message:Object.entries(JSON.parse(t.message)).map(([e,n])=>({in:e,result:n}))})):t instanceof Error?(console.error(String(t)),r.writeHead(500,V).end(JSON.stringify({statusCode:500,message:t.message}))):(console.error(String(t)),r.writeHead(500,V).end(JSON.stringify({statusCode:500,message:String(t)})))}function He(t,r){let e=JSON.stringify(r.spec),n=$.readFileSync(ye.join(__dirname,`./templates/${r.viewer}.hbs`),"utf-8").replace("{{title}}",r.spec.info.title).replace("{{specUrl}}",r.specPath).replace("{{theme}}",r.theme??"");t.get(r.specPath,(o,i)=>{i.writeHead(200,{"content-type":"application/json"}).end(e)}),t.get(r.docsPath,(o,i)=>{i.writeHead(200,{"content-type":"text/html"}).end(n)})}import q from"http-status";import{isEmpty as Y,mapEntries as Le,mapValues as ge,pascal as W,shake as Ve,title as Q}from"radash";import{z as c}from"zod";import $e from"zod-to-json-schema";var M="GeneralApiError",fe="ValidationError",qe=c.object({code:c.enum(["invalid_type","invalid_literal","unrecognized_keys","invalid_union","invalid_union_discriminator","invalid_enum_value","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite","custom"]),path:c.union([c.string(),c.number().int().min(0)]).array(),fatal:c.boolean().optional(),message:c.string()}).passthrough(),Me=c.object({in:c.enum(["body","queries","params","headers","cookies"]).describe("The part of a request where data validation failed"),result:c.array(qe).describe("An array of error items")}),he=c.object({statusCode:c.number().int().min(100).max(599).describe("The HTTP response status code"),message:c.string().describe("The message associated with the error")}).describe("A general HTTP error response"),Ge=he.extend({message:c.union([c.array(Me).describe("An array of error schemas detailing validation issues"),c.string().describe("Alternatively, a simple error message")])}).describe("An error related to the validation process with more detailed information"),Te=["https://json-schema.org/draft/2020-12/schema#","https://json-schema.org/draft/2019-09/schema#","https://json-schema.org/draft-07/schema#","https://json-schema.org/draft-06/schema#","http://json-schema.org/draft-04/schema#"];function Pt(t){let r={},e={},n=new Set,o=new Set;for(let[i,s]of Object.entries(t.paths)){let[m,...d]=i.split(":"),{path:p}=me(d.join(":")),u=[],g=r[p]??{};for(let a of s.security??[])n.add(a.security);for(let a of s.tags??[])o.add(a);for(let[a,l]of Object.entries(s.parameters??{})){let{properties:b={},required:f=[]}=B(l);for(let[R,j]of Object.entries(b)){if("$ref"in j)continue;let{description:ee,...be}=j,te=f.includes(R);u.push({name:R,in:a,...ee&&{description:ee},...te&&{required:te},schema:be})}}let x=`${W(Q(s.operationId))}RequestBody`;s.requestBody&&s.requestBody.body._def.typeName!==c.ZodVoid.name&&!(s.requestBody instanceof P)&&(e[x]=B(s.requestBody.body,s.requestBody.mimeType));let y=`${W(Q(s.operationId))}Response`;for(let[,a]of Object.entries(s.responses??{}))a instanceof P||typeof a=="object"&&a.body._def.typeName!==c.ZodVoid.name&&(e[y]=B(a.body,a.mimeType));g[m]={...s.tags?.length&&{tags:Object.values(s.tags).map(a=>a.name)},summary:s.summary||s.operationId,...s.description&&{description:s.description},operationId:s.operationId,...s.deprecated&&{deprecated:s.deprecated},...!Y(u)&&{parameters:u},...s.security?.length&&{security:s.security.map(a=>({[a.security.name]:a.scopes}))},...s.requestBody&&{requestBody:{...s.requestBody.description&&{description:s.requestBody.description},content:I(s.requestBody.mimeType,x,s.requestBody.body._def.typeName===c.ZodVoid.name||s.requestBody instanceof P,s.requestBody instanceof E||s.requestBody instanceof D?s.requestBody.encoding:void 0),required:!s.requestBody.body.isOptional()}},responses:{...ge(Ve(s.responses),(a,l)=>({description:(typeof a=="string"?a:null)||String(q[`${l}`])||"No description",content:typeof a=="boolean"||typeof a=="string"?I(h.mimeType,M):I(a.mimeType,y,a.body._def.typeName===c.ZodVoid.name||a instanceof P)})),...(s.requestBody||!Y(s.parameters))&&{400:{description:X(s.responses,400)||q[400],content:I(h.mimeType,fe)}},...s.security?.length&&{401:{description:X(s.responses,401)||q[401],content:I(h.mimeType,M)}},500:{description:X(s.responses,500)||q[500],content:I(h.mimeType,M)}}},r[p]=g}return{openapi:t.openapi,info:t.info,jsonSchemaDialect:t.jsonSchemaDialect??Te[0],paths:r,...t.webhooks&&{webhooks:t.webhooks},components:{schemas:{...e,[M]:B(he),[fe]:B(Ge),...Le(t.additionalSchemas??{},(i,s)=>[W(Q(i)),B(s)])},...n.size&&{securitySchemes:Object.fromEntries([...n.values()].map(i=>[i.name,i.schema]))}},tags:[...o.values()],...t.externalDocs&&{externalDocs:t.externalDocs}}}function I(t,r,e,n){return e?{[t]:{}}:{[t]:{schema:{$ref:`#/components/schemas/${r}`},...n&&{encoding:ge(n,o=>({...o,...o.contentType&&{contentType:o.contentType.join(", ")},...o.headers&&{headers:B(o.headers).properties}}))}}}}function X(t,r){let e=t[r];return typeof e=="string"?e:null}function B(t,r){let e=$e(t,{target:"jsonSchema2019-09"});if(r===E.mimeType)for(let n in e.properties??{})e.properties&&Y(e.properties[n])&&(e.properties[n]={type:"string",contentMediaType:"application/octet-stream"});return e.$schema=Te[0],e}import{mapKeys as Je,mapValues as Ue}from"radash";function It(t,r){let e=[],n=[];for(let o of r){let i=Object.keys(o).map(s=>L(`${t}${s}`));n.push(...e.filter(s=>i.includes(s))),e.push(...i)}if(n.length)throw new Error(`Duplicated keys occured: ${n.join(", ")}`);return Je(Object.assign({},...r),o=>L(o.replace(/:/,`:${t}`)))}function zt(t,r){return Ue(t,e=>Object.assign(e,r))}var export_oas3=Fe.OpenAPIV3_1;export{N as ApiError,J as AppliedSecurity,E as FormDataBody,pe as HtmlBody,_ as HttpResponse,h as JsonBody,de as METHODS,P as OctetStreamBody,ae as Security,U as TextBody,D as UrlEncodedBody,A as ValidationError,zt as applyGroupConfig,Pt as buildJson,lt as createApi,tt as endpoint,It as mergeEndpointGroups,export_oas3 as oas3};
//# sourceMappingURL=index.mjs.map